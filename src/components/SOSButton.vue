<template>
  <div>
    <!-- –ü–ª–∞–≤–∞—é—â–∞—è SOS –∫–Ω–æ–ø–∫–∞ -->
    <button
      v-if="authStore.isLoggedIn"
      class="fixed bottom-20 right-4 sm:bottom-8 sm:right-8 z-50 w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-red-500 to-red-700 rounded-full shadow-2xl flex items-center justify-center text-white hover:from-red-600 hover:to-red-800 transition-all transform hover:scale-110 animate-pulse-slow"
      title="–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –ø–æ–º–æ—â–∏"
      @click="showSOSModal = true"
    >
      <div class="text-center">
        <div class="text-2xl sm:text-3xl font-black">
          SOS
        </div>
      </div>
      <!-- –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç -->
      <span class="absolute inset-0 rounded-full bg-red-500 animate-ping opacity-30" />
    </button>

    <!-- SOS –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div
      v-if="showSOSModal"
      class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"
      @click.self="showSOSModal = false"
    >
      <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full p-6 transform animate-slide-up">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-6">
          <div class="text-6xl mb-3">
            üÜò
          </div>
          <h2 class="text-3xl font-black text-gray-900 dark:text-white">
            –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å
          </h2>
          <p class="text-gray-500 text-sm mt-2">
            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞
          </p>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <div class="grid grid-cols-2 gap-3 mb-6">
          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 hover:from-yellow-100 hover:to-yellow-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('battery')"
          >
            <div class="text-3xl mb-1">
              üîã
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –°–µ–ª –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä
            </div>
          </button>

          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('fuel')"
          >
            <div class="text-3xl mb-1">
              ‚õΩ
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –ó–∞–∫–æ–Ω—á–∏–ª—Å—è –±–µ–Ω–∑–∏–Ω
            </div>
          </button>

          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('tire')"
          >
            <div class="text-3xl mb-1">
              üõû
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –ü—Ä–æ–±–∏—Ç–æ –∫–æ–ª–µ—Å–æ
            </div>
          </button>

          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('towing')"
          >
            <div class="text-3xl mb-1">
              üöó
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –ù—É–∂–Ω–∞ –±—É–∫—Å–∏—Ä–æ–≤–∫–∞
            </div>
          </button>

          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('road_conflict')"
          >
            <div class="text-3xl mb-1">
              üö®
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –ö–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞ –¥–æ—Ä–æ–≥–µ
            </div>
          </button>

          <button
            :disabled="isCreating"
            class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded-2xl transition transform hover:scale-105"
            @click="quickRequest('other')"
          >
            <div class="text-3xl mb-1">
              üîß
            </div>
            <div class="font-bold text-gray-800 text-sm">
              –î—Ä—É–≥–∞—è –ø—Ä–æ–±–ª–µ–º–∞
            </div>
          </button>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div
          v-if="isCreating"
          class="text-center py-4"
        >
          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600 mx-auto" />
          <p class="mt-2 text-gray-600">
            –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...
          </p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="flex gap-3">
          <button
            class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition"
            @click="showSOSModal = false"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <router-link
            to="/create-request"
            class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition text-center"
            @click="showSOSModal = false"
          >
            –ü–æ–¥—Ä–æ–±–Ω–∞—è –∑–∞—è–≤–∫–∞
          </router-link>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { apiService } from '@/services/api'

const router = useRouter()
const authStore = useAuthStore()

const showSOSModal = ref(false)
const isCreating = ref(false)

const quickRequest = async (problemType) => {
  try {
    isCreating.value = true
    
    // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
    let latitude = 55.7558
    let longitude = 37.6173
    let address = '–ú–æ—Å–∫–≤–∞'
    
    if ('geolocation' in navigator) {
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          })
        })
        latitude = position.coords.latitude
        longitude = position.coords.longitude
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å
        try {
          const geoResponse = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=ru`
          )
          const geoData = await geoResponse.json()
          if (geoData.display_name) {
            address = geoData.display_name.split(',').slice(0, 3).join(',')
          }
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å')
        }
      } catch (geoError) {
        console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', geoError)
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –≤—Ä—É—á–Ω—É—é.')
        router.push('/create-request')
        return
      }
    }
    
    // –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É
    const problemLabels = {
      battery: '–°—Ä–æ—á–Ω–æ! –°–µ–ª –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä',
      fuel: '–°—Ä–æ—á–Ω–æ! –ó–∞–∫–æ–Ω—á–∏–ª–æ—Å—å —Ç–æ–ø–ª–∏–≤–æ',
      tire: '–°—Ä–æ—á–Ω–æ! –ü—Ä–æ–±–∏—Ç–æ –∫–æ–ª–µ—Å–æ',
      towing: '–°—Ä–æ—á–Ω–æ! –ù—É–∂–Ω–∞ –±—É–∫—Å–∏—Ä–æ–≤–∫–∞',
      road_conflict: '–°—Ä–æ—á–Ω–æ! –ö–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞ –¥–æ—Ä–æ–≥–µ',
      other: '–°—Ä–æ—á–Ω–æ! –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å'
    }
    
    const response = await apiService.createHelpRequest({
      problem_type: problemType,
      description: problemLabels[problemType] + ' (—Å–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ SOS)',
      address: address,
      location: {
        type: 'Point',
        coordinates: [longitude, latitude]
      },
      is_urgent: true
    })
    
    if (response.success) {
      showSOSModal.value = false
      alert('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–∫–ª–∏–∫–æ–≤.')
      router.push('/my-requests')
    } else {
      throw new Error(response.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏')
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è SOS-–∑–∞—è–≤–∫–∏:', error)
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'))
  } finally {
    isCreating.value = false
  }
}
</script>

<style scoped>
@keyframes pulse-slow {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.9;
  }
}

.animate-pulse-slow {
  animation: pulse-slow 2s ease-in-out infinite;
}

@keyframes slide-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-slide-up {
  animation: slide-up 0.3s ease-out;
}
</style>
