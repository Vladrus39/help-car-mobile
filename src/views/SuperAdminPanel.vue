<template>
  <div class="min-h-screen bg-gray-100">
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <h1 class="text-xl font-bold text-gray-900">
              üîß –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å
            </h1>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600">{{ admin?.full_name || admin?.username }}</span>
            <button
              class="bg-gray-600 text-white px-4 py-2 rounded text-sm hover:bg-gray-700"
              @click="goToHome"
            >
              üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </button>
            <button
              class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700"
              @click="goToDashboard"
            >
              ‚Üê –î–∞—à–±–æ—Ä–¥
            </button>
            <button
              class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700"
              @click="logout"
            >
              –í—ã–π—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'files'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'files'"
          >
            üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–∞–π–ª–∞–º–∏
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'system'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'system'"
          >
            ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'database'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'database'"
          >
            üóÑÔ∏è –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'users'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'users'"
          >
            üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'monitoring'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'monitoring'"
          >
            üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'terminal'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'terminal'"
          >
            üíª –¢–µ—Ä–º–∏–Ω–∞–ª
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'visual-editor'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'visual-editor'"
          >
            üé® –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'system-control'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'system-control'"
          >
            üîß –°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å
          </button>
          <button
            :class="[
              'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm',
              activeTab === 'visual-interface-editor'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
            @click="activeTab = 'visual-interface-editor'"
          >
            üé® –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          </button>
        </nav>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–∞–π–ª–∞–º–∏ -->
      <div
        v-if="activeTab === 'files'"
        class="bg-white rounded-lg shadow p-6"
      >
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xl font-bold">
            üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–∞–π–ª–∞–º–∏
          </h2>
          <button
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            @click="refreshFileList"
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º -->
          <div class="lg:col-span-1">
            <div class="mb-4">
              <input
                v-model="filePath"
                type="text"
                placeholder="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: /home/vmroadhelp/backend/src/server.js)"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <div class="mt-2 flex space-x-2">
                <button
                  class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                  @click="loadFile"
                >
                  üìñ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
                <button
                  class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                  @click="listDirectory"
                >
                  üìÇ –°–ø–∏—Å–æ–∫
                </button>
              </div>
            </div>

            <div class="border border-gray-300 rounded-md p-4 max-h-96 overflow-y-auto">
              <div
                v-if="fileList.length === 0"
                class="text-gray-500 text-sm"
              >
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
              </div>
              <div v-else>
                <div
                  v-for="item in fileList"
                  :key="item.path"
                  :class="[
                    'p-2 cursor-pointer rounded hover:bg-gray-100',
                    selectedFile?.path === item.path ? 'bg-blue-100' : ''
                  ]"
                  @click="selectFile(item)"
                >
                  <span v-if="item.type === 'directory'">üìÅ</span>
                  <span v-else>üìÑ</span>
                  <span class="ml-2 text-sm">{{ item.name }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–∞–π–ª–∞ -->
          <div class="lg:col-span-2">
            <div
              v-if="!currentFileContent"
              class="text-gray-500 text-center py-12"
            >
              –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            </div>
            <div v-else>
              <div class="mb-4 flex items-center justify-between">
                <div>
                  <h3 class="font-medium">
                    {{ selectedFile?.name || '–§–∞–π–ª' }}
                  </h3>
                  <p class="text-sm text-gray-500">
                    {{ selectedFile?.path }}
                  </p>
                </div>
                <div class="flex space-x-2">
                  <button
                    :disabled="saving"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50"
                    @click="saveFile"
                  >
                    {{ saving ? 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
                  </button>
                  <button
                    class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                    @click="reloadFile"
                  >
                    üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                  </button>
                </div>
              </div>

              <div class="relative">
                <textarea
                  v-model="currentFileContent"
                  class="w-full h-96 font-mono text-sm border border-gray-300 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-900 text-green-400"
                  placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞..."
                  style="tab-size: 2;"
                  spellcheck="false"
                />
                <div class="absolute top-2 right-2 text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded">
                  {{ getFileExtension(selectedFile?.name) }}
                </div>
              </div>

              <div
                v-if="saveMessage"
                :class="['mt-2 p-2 rounded', saveMessage.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800']"
              >
                {{ saveMessage.text }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π -->
      <div
        v-if="activeTab === 'system'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Docker -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üê≥ Docker
            </h3>
            <div class="space-y-2">
              <button
                class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                @click="loadDockerContainers"
              >
                –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
              </button>
              <button
                class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                @click="restartBackendService"
              >
                –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Backend
              </button>
              <button
                class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                @click="restartFrontendService"
              >
                –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Frontend
              </button>
              <button
                class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                @click="getBackendLogs"
              >
                –õ–æ–≥–∏ Backend
              </button>
            </div>
          </div>

          <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ –°–µ—Ä–≤–∏—Å—ã
            </h3>
            <div class="space-y-2">
              <button
                class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                @click="getNginxStatus"
              >
                –°—Ç–∞—Ç—É—Å Nginx
              </button>
              <button
                class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                @click="restartNginxService"
              >
                –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx
              </button>
              <button
                class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                @click="getPostgresStatus"
              >
                –°—Ç–∞—Ç—É—Å PostgreSQL
              </button>
              <button
                class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                @click="restartPostgresService"
              >
                –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
              </button>
            </div>
          </div>

          <!-- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ -->
          <div class="border border-gray-300 rounded-lg p-4 md:col-span-2">
            <h3 class="font-bold mb-4">
              üíª –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
            </h3>
            <div class="flex space-x-2">
              <input
                v-model="customCommand"
                type="text"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ls -la /home/vmroadhelp)"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                @keyup.enter="executeSystemCommand(customCommand)"
              >
              <button
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                @click="executeSystemCommand(customCommand)"
              >
                –í—ã–ø–æ–ª–Ω–∏—Ç—å
              </button>
            </div>
          </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã -->
        <div
          v-if="commandResult"
          class="mt-6 border border-gray-300 rounded-lg p-4 bg-gray-50"
        >
          <h3 class="font-bold mb-2">
            –†–µ–∑—É–ª—å—Ç–∞—Ç:
          </h3>
          <pre class="text-sm overflow-x-auto whitespace-pre-wrap">{{ commandResult }}</pre>
        </div>
      </div>

      <!-- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö -->
      <div
        v-if="activeTab === 'database'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–∞–∑–æ–π –î–∞–Ω–Ω—ã—Ö
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="getDatabaseStats"
            >
              –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            </button>
            <div
              v-if="dbStats"
              class="mt-4 space-y-2"
            >
              <div
                v-for="(value, key) in dbStats"
                :key="key"
                class="flex justify-between"
              >
                <span class="font-medium">{{ key }}:</span>
                <span>{{ value }}</span>
              </div>
            </div>
          </div>
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üîç SQL –ó–∞–ø—Ä–æ—Å
            </h3>
            <textarea
              v-model="sqlQuery"
              class="w-full h-32 font-mono text-sm border border-gray-300 rounded-md p-2 mb-2"
              placeholder="SELECT * FROM users LIMIT 10;"
            />
            <button
              class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
              @click="executeSQL"
            >
              –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL
            </button>
            <div
              v-if="sqlResult"
              class="mt-4"
            >
              <pre class="text-sm overflow-x-auto whitespace-pre-wrap">{{ sqlResult }}</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div
        v-if="activeTab === 'users'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        </h2>
        <div class="mb-4">
          <button
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            @click="loadUsers"
          >
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          </button>
        </div>
        <div
          v-if="users.length > 0"
          class="overflow-x-auto"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ID
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  –ò–º—è
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  Email
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  –¢–µ–ª–µ—Ñ–æ–Ω
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  üèÖ –°—Ç–∞—Ç—É—Å
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  –î–µ–π—Å—Ç–≤–∏—è
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr
                v-for="user in users"
                :key="user.id"
              >
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {{ user.id?.substring(0, 8) }}...
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <span :class="getPremiumNameClass(user.premium_status)">
                    {{ getPremiumIcon(user.premium_status) }} {{ user.full_name || user.name }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {{ user.email }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {{ user.phone }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <select
                    :value="user.premium_status || ''"
                    class="border rounded px-2 py-1 text-sm"
                    :class="getPremiumSelectClass(user.premium_status)"
                    @change="setPremiumStatus(user.id, $event.target.value)"
                  >
                    <option value="">–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞</option>
                    <option value="bronze">ü•â –ë—Ä–æ–Ω–∑–æ–≤—ã–π</option>
                    <option value="silver">ü•à –°–µ—Ä–µ–±—Ä—è–Ω—ã–π</option>
                    <option value="gold">ü•á –ó–æ–ª–æ—Ç–æ–π</option>
                  </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <button
                    class="text-blue-600 hover:text-blue-800"
                    @click="editUser(user)"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="text-red-600 hover:text-red-800 ml-2"
                    @click="deleteUser(user.id)"
                  >
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ -->
      <div
        v-if="activeTab === 'monitoring'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –°–∏—Å—Ç–µ–º—ã
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-2">
              üíæ –ü–∞–º—è—Ç—å
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="getSystemInfo('memory')"
            >
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
            <pre
              v-if="systemInfo.memory"
              class="mt-2 text-xs"
            >{{ systemInfo.memory }}</pre>
          </div>
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-2">
              üíø –î–∏—Å–∫
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="getSystemInfo('disk')"
            >
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
            <pre
              v-if="systemInfo.disk"
              class="mt-2 text-xs"
            >{{ systemInfo.disk }}</pre>
          </div>
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-2">
              ‚ö° CPU
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="getSystemInfo('cpu')"
            >
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
            <pre
              v-if="systemInfo.cpu"
              class="mt-2 text-xs"
            >{{ systemInfo.cpu }}</pre>
          </div>
        </div>
      </div>

      <!-- –¢–µ—Ä–º–∏–Ω–∞–ª -->
      <div
        v-if="activeTab === 'terminal'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üíª –¢–µ—Ä–º–∏–Ω–∞–ª (PowerShell-like)
        </h2>
        <div
          ref="terminalOutput"
          class="border border-gray-300 rounded-lg bg-black text-green-400 font-mono text-sm p-4 h-96 overflow-y-auto"
        >
          <div
            v-for="(line, index) in terminalLines"
            :key="index"
            :class="line.type === 'error' ? 'text-red-400' : line.type === 'stderr' ? 'text-yellow-400' : 'text-green-400'"
          >
            {{ line.data }}
          </div>
          <div
            v-if="terminalPrompt"
            class="flex items-center mt-2"
          >
            <span class="text-green-400">{{ terminalPrompt }}</span>
            <input
              v-model="terminalInput"
              class="flex-1 bg-transparent text-green-400 outline-none ml-2"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..."
              @keyup.enter="executeTerminalCommand"
            >
          </div>
        </div>
        <div class="mt-4 flex space-x-2">
          <button
            class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
            @click="clearTerminal"
          >
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
          </button>
          <button
            :disabled="terminalConnected"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50"
            @click="connectTerminal"
          >
            {{ terminalConnected ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : 'üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å' }}
          </button>
        </div>
      </div>

      <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
      <div
        v-if="activeTab === 'visual-editor'"
        class="bg-white rounded-lg shadow p-6"
      >
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold">
            üé® –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä –°–∞–π—Ç–∞
          </h2>
          <div class="flex gap-2">
            <select
              v-model="previewPage"
              class="px-4 py-2 border border-gray-300 rounded"
            >
              <option value="/">
                üè† –ì–ª–∞–≤–Ω–∞—è
              </option>
              <option value="/map">
                üó∫Ô∏è –ö–∞—Ä—Ç–∞
              </option>
              <option value="/profile">
                üë§ –ü—Ä–æ—Ñ–∏–ª—å
              </option>
              <option value="/admin/dashboard">
                ‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
              </option>
            </select>
            <button
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="refreshPreview"
            >
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button
              :class="[
                'px-4 py-2 rounded transition-colors',
                inspectMode ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              ]"
              @click="toggleInspectMode"
            >
              {{ inspectMode ? 'üéØ –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä ON' : 'üéØ –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä OFF' }}
            </button>
            <button
              :class="[
                'px-4 py-2 rounded transition-colors',
                editMode ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              ]"
              @click="toggleEditMode"
            >
              {{ editMode ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä ON' : '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä OFF' }}
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ñ–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–∞–π—Ç–∞ -->
          <div class="lg:col-span-2">
            <div
              class="border border-gray-300 rounded-lg overflow-hidden"
              style="height: 800px;"
            >
              <div class="bg-gray-100 px-4 py-2 border-b border-gray-300 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="flex gap-1.5">
                    <div class="w-3 h-3 rounded-full bg-red-500" />
                    <div class="w-3 h-3 rounded-full bg-yellow-500" />
                    <div class="w-3 h-3 rounded-full bg-green-500" />
                  </div>
                  <span class="text-sm text-gray-600 ml-4">{{ siteUrl }}{{ previewPage }}</span>
                </div>
                <div class="flex gap-2">
                  <button
                    :class="['text-xs px-3 py-1.5 rounded font-medium', viewportSize === 'mobile' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700']"
                    @click="setViewportSize('mobile')"
                  >
                    üì± 375px
                  </button>
                  <button
                    :class="['text-xs px-3 py-1.5 rounded font-medium', viewportSize === 'tablet' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700']"
                    @click="setViewportSize('tablet')"
                  >
                    üì± 768px
                  </button>
                  <button
                    :class="['text-xs px-3 py-1.5 rounded font-medium', viewportSize === 'desktop' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700']"
                    @click="setViewportSize('desktop')"
                  >
                    üñ•Ô∏è 100%
                  </button>
                  <button
                    v-if="viewportSize === 'mobile'"
                    :class="['text-xs px-3 py-1.5 rounded font-medium ml-2', isZoomed ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700']"
                    @click="toggleZoom"
                  >
                    {{ isZoomed ? 'üîç 150%' : 'üîé 100%' }}
                  </button>
                </div>
              </div>
              <div
                class="relative bg-white flex justify-center"
                style="height: calc(100% - 50px);"
              >
                <div
                  :style="{
                    width: viewportSize === 'mobile' ? '375px' : viewportSize === 'tablet' ? '768px' : '100%',
                    height: '100%',
                    position: 'relative',
                    boxShadow: viewportSize !== 'desktop' ? '0 0 20px rgba(0,0,0,0.1)' : 'none'
                  }"
                >
                  <iframe
                    ref="previewIframe"
                    :src="siteUrl + previewPage"
                    :style="{
                      width: '100%',
                      height: '100%',
                      border: 'none',
                      transform: isZoomed && viewportSize === 'mobile' ? 'scale(1.5)' : 'scale(1)',
                      transformOrigin: 'top center',
                      transition: 'transform 0.3s ease'
                    }"
                    @load="onIframeLoad"
                  />
                </div>
                <div
                  v-if="inspectMode || editMode"
                  class="absolute top-2 left-2 bg-green-600 text-white text-xs px-3 py-1 rounded shadow-lg pointer-events-none z-50"
                >
                  <div v-if="editMode">
                    <div>‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</div>
                    <div class="text-xs mt-1">
                      ‚Ä¢ –ö–ª–∏–∫ - –≤—ã–±—Ä–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç
                    </div>
                    <div class="text-xs">
                      ‚Ä¢ <kbd class="bg-white text-green-600 px-1 rounded">Ctrl</kbd> + –∫–ª–∏–∫ - —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                    </div>
                    <div class="text-xs">
                      ‚Ä¢ –¢—è–Ω–∏—Ç–µ –∑–∞ —É–≥–ª—ã - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                    </div>
                  </div>
                  <div v-else-if="inspectMode">
                    üéØ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä —Å–≤–æ–π—Å—Ç–≤ -->
          <div class="lg:col-span-1">
            <div
              class="border border-gray-300 rounded-lg p-4 sticky top-4"
              style="max-height: 800px; overflow-y: auto;"
            >
              <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
              <div
                v-if="editMode"
                class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded"
              >
                <h3 class="font-bold mb-3 text-purple-900">
                  ‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç
                </h3>
                <div class="grid grid-cols-2 gap-2">
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('button')"
                  >
                    üîò –ö–Ω–æ–ø–∫–∞
                  </button>
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('text')"
                  >
                    üìù –¢–µ–∫—Å—Ç
                  </button>
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('heading')"
                  >
                    üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫
                  </button>
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('image')"
                  >
                    üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞
                  </button>
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('div')"
                  >
                    üì¶ –ë–ª–æ–∫
                  </button>
                  <button
                    class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm"
                    @click="addElement('input')"
                  >
                    ‚å®Ô∏è –ü–æ–ª–µ –≤–≤–æ–¥–∞
                  </button>
                </div>
              </div>

              <h3 class="font-bold mb-4">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤
              </h3>
              
              <div
                v-if="!selectedElement"
                class="text-gray-500 text-center py-12"
              >
                <p class="mb-2">
                  –í–∫–ª—é—á–∏—Ç–µ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –∏
                </p>
                <p>–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç–µ</p>
              </div>
              
              <div
                v-else
                class="space-y-4"
              >
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ -->
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                  <div class="text-xs font-mono text-gray-600 mb-1">
                    {{ selectedElement.tagName }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ selectedElement.selector }}
                  </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
                <div class="flex border-b border-gray-300">
                  <button
                    :class="['px-4 py-2 text-sm font-medium', editorTab === 'content' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500']"
                    @click="editorTab = 'content'"
                  >
                    üìù –ö–æ–Ω—Ç–µ–Ω—Ç
                  </button>
                  <button
                    :class="['px-4 py-2 text-sm font-medium', editorTab === 'styles' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500']"
                    @click="editorTab = 'styles'"
                  >
                    üé® –°—Ç–∏–ª–∏
                  </button>
                  <button
                    :class="['px-4 py-2 text-sm font-medium', editorTab === 'size' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500']"
                    @click="editorTab = 'size'"
                  >
                    üìê –†–∞–∑–º–µ—Ä—ã
                  </button>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
                <div
                  v-if="editorTab === 'content'"
                  class="space-y-3"
                >
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–∫—Å—Ç</label>
                    <textarea
                      v-model="selectedElement.textContent"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                      rows="4"
                      @input="updateElementContent"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">HTML</label>
                    <textarea
                      v-model="selectedElement.innerHTML"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 font-mono text-xs"
                      rows="6"
                      @input="updateElementHTML"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–ª–∞—Å—Å—ã CSS</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                      <span
                        v-for="className in selectedElement.classes"
                        :key="className"
                        class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm flex items-center gap-1"
                      >
                        {{ className }}
                        <button
                          class="text-blue-600 hover:text-blue-800"
                          @click="removeClass(className)"
                        >√ó</button>
                      </span>
                    </div>
                    <div class="flex gap-2">
                      <input
                        v-model="newClassName"
                        type="text"
                        placeholder="–ù–æ–≤—ã–π –∫–ª–∞—Å—Å"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                        @keyup.enter="addClass"
                      >
                      <button
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                        @click="addClass"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>

                <!-- –°—Ç–∏–ª–∏ -->
                <div
                  v-if="editorTab === 'styles'"
                  class="space-y-3"
                >
                  <div
                    v-for="(value, property) in selectedElement.styles"
                    :key="property"
                  >
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ property }}</label>
                    <input
                      v-model="selectedElement.styles[property]"
                      type="text"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                      @input="updateElementStyle(property)"
                    >
                  </div>
                  <button
                    class="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 text-sm"
                    @click="addNewStyle"
                  >
                    + –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª—å
                  </button>
                </div>

                <!-- –†–∞–∑–º–µ—Ä—ã -->
                <div
                  v-if="editorTab === 'size'"
                  class="space-y-3"
                >
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–®–∏—Ä–∏–Ω–∞ (width)</label>
                    <div class="flex gap-2">
                      <input
                        v-model="elementWidth"
                        type="text"
                        placeholder="auto, 100px, 50%"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                        @input="updateElementWidth"
                      >
                      <button
                        class="px-3 py-2 bg-gray-200 rounded text-sm"
                        @click="elementWidth = 'auto'; updateElementWidth()"
                      >
                        Auto
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–í—ã—Å–æ—Ç–∞ (height)</label>
                    <div class="flex gap-2">
                      <input
                        v-model="elementHeight"
                        type="text"
                        placeholder="auto, 100px, 50%"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                        @input="updateElementHeight"
                      >
                      <button
                        class="px-3 py-2 bg-gray-200 rounded text-sm"
                        @click="elementHeight = 'auto'; updateElementHeight()"
                      >
                        Auto
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–û—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ (padding)</label>
                    <input
                      v-model="elementPadding"
                      type="text"
                      placeholder="10px, 10px 20px"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                      @input="updateElementPadding"
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–û—Ç—Å—Ç—É–ø—ã —Å–Ω–∞—Ä—É–∂–∏ (margin)</label>
                    <input
                      v-model="elementMargin"
                      type="text"
                      placeholder="10px, 10px 20px"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm"
                      @input="updateElementMargin"
                    >
                  </div>
                  <div class="flex items-center gap-2">
                    <input
                      id="enable-resize"
                      v-model="enableResize"
                      type="checkbox"
                      class="w-4 h-4"
                      @change="toggleResize"
                    >
                    <label
                      for="enable-resize"
                      class="text-sm text-gray-700"
                    >üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –º—ã—à—å—é</label>
                  </div>
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="border-t border-gray-300 pt-4 space-y-2">
                  <button
                    class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                    @click="deleteElement"
                  >
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç
                  </button>
                  <button
                    class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
                    @click="duplicateElement"
                  >
                    üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                  </button>
                  <button
                    :disabled="savingChanges"
                    class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50"
                    @click="saveChangesToFile"
                  >
                    {{ savingChanges ? 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª' }}
                  </button>
                  <button
                    :disabled="isDeploying"
                    class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
                    @click="buildAndDeploy"
                  >
                    {{ isDeploying ? 'üöÄ –î–µ–ø–ª–æ–π...' : 'üöÄ –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å' }}
                  </button>
                  <button
                    class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300"
                    @click="resetElement"
                  >
                    ‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                  </button>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div
                  v-if="editorMessage"
                  :class="[
                    'p-3 rounded text-sm',
                    editorMessage.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  ]"
                >
                  {{ editorMessage.text }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
          <button
            class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
            @click="clearCache"
          >
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
          </button>
          <button
            class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
            @click="exportChanges"
          >
            üì¶ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          </button>
          <button
            class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"
            @click="undoChanges"
          >
            ‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
          </button>
          <button
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            @click="refreshComponents"
          >
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          </button>
        </div>
      </div>

      <!-- –°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å -->
      <div
        v-if="activeTab === 'system-control'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üîß –°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- –ü—Ä–æ—Ü–µ—Å—Å—ã -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              ‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å—ã
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadProcesses"
            >
              üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã
            </button>
            <div
              v-if="processes"
              class="mt-4 max-h-64 overflow-y-auto"
            >
              <pre class="text-xs bg-gray-100 p-2 rounded">{{ processes }}</pre>
            </div>
          </div>

          <!-- Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üê≥ Docker
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadDockerContainers"
            >
              üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            </button>
            <div
              v-if="dockerContainers.length > 0"
              class="mt-4 space-y-2 max-h-64 overflow-y-auto"
            >
              <div
                v-for="container in dockerContainers"
                :key="container.id"
                class="p-2 bg-gray-50 rounded text-sm"
              >
                <div class="font-medium">
                  {{ container.name }}
                </div>
                <div class="text-xs text-gray-600">
                  {{ container.status }}
                </div>
                <button
                  class="mt-1 text-xs bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700"
                  @click="restartContainer(container.id)"
                >
                  üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                </button>
              </div>
            </div>
          </div>

          <!-- –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üìã –õ–æ–≥–∏
            </h3>
            <select
              v-model="selectedLogService"
              class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md"
            >
              <option value="backend">
                Backend
              </option>
              <option value="nginx">
                Nginx
              </option>
              <option value="all">
                –í—Å–µ
              </option>
            </select>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadRealtimeLogs"
            >
              üìú –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏
            </button>
            <div
              v-if="realtimeLogs"
              class="mt-4 max-h-64 overflow-y-auto"
            >
              <pre class="text-xs bg-gray-900 text-green-400 p-2 rounded font-mono">{{ realtimeLogs }}</pre>
            </div>
          </div>

          <!-- Git —Å—Ç–∞—Ç—É—Å -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üì¶ Git
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadGitStatus"
            >
              üîç –°—Ç–∞—Ç—É—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            </button>
            <div
              v-if="gitStatus"
              class="mt-4 space-y-2"
            >
              <div class="text-sm">
                <span class="font-medium">–í–µ—Ç–∫–∞:</span> {{ gitStatus.branch }}
              </div>
              <div class="text-sm">
                <span class="font-medium">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:</span> {{ gitStatus.lastCommit }}
              </div>
              <div
                v-if="gitStatus.status"
                class="text-xs bg-yellow-50 p-2 rounded"
              >
                <span class="font-medium">–ò–∑–º–µ–Ω–µ–Ω–∏—è:</span>
                <pre class="mt-1">{{ gitStatus.status }}</pre>
              </div>
            </div>
          </div>

          <!-- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üåç –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadEnvironmentVariables"
            >
              üîç –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            </button>
            <div
              v-if="environmentVariables"
              class="mt-4 max-h-64 overflow-y-auto"
            >
              <div
                v-for="(value, key) in environmentVariables"
                :key="key"
                class="text-xs mb-1"
              >
                <span class="font-medium">{{ key }}:</span> {{ value }}
              </div>
            </div>
          </div>

          <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
          <div class="border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </h3>
            <button
              class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-2"
              @click="loadActiveConnections"
            >
              üìä –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </button>
            <div
              v-if="activeConnections"
              class="mt-4"
            >
              <div class="text-sm mb-2">
                <span class="font-medium">–í—Å–µ–≥–æ:</span> {{ activeConnections.count }}
              </div>
              <div class="max-h-48 overflow-y-auto">
                <pre class="text-xs bg-gray-100 p-2 rounded">{{ activeConnections.connections.join('\n') }}</pre>
              </div>
            </div>
          </div>
        </div>

        <!-- –ë—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ -->
        <div class="mt-6 border border-gray-300 rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg">
              üìÅ –ë—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            </h3>
            <button
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm"
              @click="refreshFileBrowser"
            >
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="lg:col-span-1">
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</label>
                <div class="flex space-x-2">
                  <input
                    v-model="fileBrowserPath"
                    type="text"
                    placeholder="/home/vmroadhelp"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm"
                    @keyup.enter="loadFileBrowser"
                  >
                  <button
                    class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm"
                    @click="loadFileBrowser"
                  >
                    üìÇ –û—Ç–∫—Ä—ã—Ç—å
                  </button>
                </div>
                <div class="mt-2 flex space-x-2">
                  <button
                    class="flex-1 bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm"
                    @click="goToParentDirectory"
                  >
                    ‚¨ÜÔ∏è –ù–∞–≤–µ—Ä—Ö
                  </button>
                  <button
                    class="flex-1 bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm"
                    @click="showCreateDirectoryModal = true"
                  >
                    ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É
                  </button>
                </div>
              </div>

              <div class="border border-gray-300 rounded-md p-3 max-h-96 overflow-y-auto bg-gray-50">
                <div
                  v-if="fileBrowserItems.length === 0"
                  class="text-gray-500 text-sm text-center py-8"
                >
                  –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
                <div
                  v-else
                  class="space-y-1"
                >
                  <div
                    v-for="item in fileBrowserItems"
                    :key="item.path"
                    :class="[
                      'p-2 cursor-pointer rounded text-sm flex items-center justify-between hover:bg-blue-50',
                      selectedFileBrowserItem?.path === item.path ? 'bg-blue-100 border border-blue-300' : ''
                    ]"
                    @click="selectFileBrowserItem(item)"
                    @dblclick="openFileBrowserItem(item)"
                  >
                    <div class="flex items-center space-x-2 flex-1 min-w-0">
                      <span class="text-lg">{{ item.type === 'directory' ? 'üìÅ' : 'üìÑ' }}</span>
                      <span class="truncate">{{ item.name }}</span>
                    </div>
                    <div class="flex items-center space-x-1 ml-2">
                      <button
                        class="text-red-600 hover:text-red-800 text-xs px-1"
                        title="–£–¥–∞–ª–∏—Ç—å"
                        @click.stop="deleteFileBrowserItem(item)"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä/–ü—Ä–æ—Å–º–æ—Ç—Ä -->
            <div class="lg:col-span-2">
              <div
                v-if="!selectedFileBrowserItem"
                class="text-gray-500 text-center py-12 border border-gray-300 rounded-md bg-gray-50"
              >
                –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              </div>
              <div
                v-else-if="selectedFileBrowserItem.type === 'directory'"
                class="text-gray-500 text-center py-12 border border-gray-300 rounded-md bg-gray-50"
              >
                –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {{ selectedFileBrowserItem.name }}<br>
                <button
                  class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                  @click="openFileBrowserItem(selectedFileBrowserItem)"
                >
                  –û—Ç–∫—Ä—ã—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                </button>
              </div>
              <div v-else>
                <div class="mb-4 flex items-center justify-between">
                  <div>
                    <h4 class="font-medium">
                      {{ selectedFileBrowserItem.name }}
                    </h4>
                    <p class="text-xs text-gray-500">
                      {{ selectedFileBrowserItem.path }}
                    </p>
                  </div>
                  <div class="flex space-x-2">
                    <button
                      :disabled="savingFileBrowser"
                      class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50 text-sm"
                      @click="saveFileBrowserFile"
                    >
                      {{ savingFileBrowser ? 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
                    </button>
                    <button
                      class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm"
                      @click="reloadFileBrowserFile"
                    >
                      üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                  </div>
                </div>

                <textarea
                  v-model="fileBrowserContent"
                  class="w-full h-96 font-mono text-sm border border-gray-300 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-900 text-green-400"
                  placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞..."
                  style="tab-size: 2;"
                  spellcheck="false"
                />

                <div
                  v-if="fileBrowserSaveMessage"
                  :class="['mt-2 p-2 rounded text-sm', fileBrowserSaveMessage.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800']"
                >
                  {{ fileBrowserSaveMessage.text }}
                </div>
              </div>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
          <div class="mt-4 flex flex-wrap gap-2">
            <button
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm"
              @click="showCreateFileModal = true"
            >
              ‚ûï –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
            </button>
            <button
              class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm"
              @click="showUploadFileModal = true"
            >
              üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </button>
            <input
              ref="fileUploadInput"
              type="file"
              class="hidden"
              @change="handleFileUpload"
            >
          </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ -->
        <div
          v-if="showCreateDirectoryModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          @click="showCreateDirectoryModal = false"
        >
          <div
            class="bg-white rounded-lg p-6 max-w-md w-full mx-4"
            @click.stop
          >
            <h3 class="text-xl font-bold mb-4">
              ‚ûï –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            </h3>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">–ò–º—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:</label>
              <input
                v-model="newDirectoryName"
                type="text"
                placeholder="–ù–æ–≤–∞—è –ø–∞–ø–∫–∞"
                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                @keyup.enter="createDirectory"
              >
              <p class="text-xs text-gray-500 mt-1">
                –ü—É—Ç—å: {{ fileBrowserPath }}/{{ newDirectoryName }}
              </p>
            </div>
            <div class="flex justify-end space-x-2">
              <button
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                @click="showCreateDirectoryModal = false"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                @click="createDirectory"
              >
                –°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ -->
        <div
          v-if="showCreateFileModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          @click="showCreateFileModal = false"
        >
          <div
            class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
            @click.stop
          >
            <h3 class="text-xl font-bold mb-4">
              ‚ûï –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
            </h3>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">–ò–º—è —Ñ–∞–π–ª–∞:</label>
              <input
                v-model="newFileName"
                type="text"
                placeholder="example.txt"
                class="w-full px-3 py-2 border border-gray-300 rounded-md"
              >
              <p class="text-xs text-gray-500 mt-1">
                –ü—É—Ç—å: {{ fileBrowserPath }}/{{ newFileName }}
              </p>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
              <textarea
                v-model="newFileContent"
                class="w-full h-64 font-mono text-sm border border-gray-300 rounded-md p-4"
                placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞..."
              />
            </div>
            <div class="flex justify-end space-x-2">
              <button
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                @click="showCreateFileModal = false"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                @click="createFile"
              >
                –°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div
          v-if="showUploadFileModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          @click="showUploadFileModal = false"
        >
          <div
            class="bg-white rounded-lg p-6 max-w-md w-full mx-4"
            @click.stop
          >
            <h3 class="text-xl font-bold mb-4">
              üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </h3>
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">
                –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
              </p>
              <p class="text-xs text-gray-500 mb-4">
                –ü—É—Ç—å: {{ fileBrowserPath }}/
              </p>
              <button
                class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                @click="fileUploadInput?.click()"
              >
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </button>
            </div>
            <div class="flex justify-end space-x-2">
              <button
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                @click="showUploadFileModal = false"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
      <div
        v-if="activeTab === 'visual-interface-editor'"
        class="bg-white rounded-lg shadow p-6"
      >
        <h2 class="text-xl font-bold mb-4">
          üé® –í–∏–∑—É–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
          <div class="lg:col-span-1 border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            </h3>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              <div
                v-for="component in availableComponents"
                :key="component.name"
                :class="[
                  'p-3 border rounded cursor-pointer hover:bg-blue-50',
                  selectedComponentForEdit?.name === component.name ? 'border-blue-500 bg-blue-50' : 'border-gray-300'
                ]"
                @click="selectComponentForEdit(component)"
              >
                <div class="font-medium">
                  {{ component.name }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ component.path }}
                </div>
              </div>
            </div>
            <button
              class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="loadAvailableComponents"
            >
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            </button>
          </div>

          <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä -->
          <div class="lg:col-span-1 border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä
            </h3>
            <div
              v-if="selectedComponentForEdit"
              class="space-y-4"
            >
              <div>
                <div class="font-medium mb-2">
                  {{ selectedComponentForEdit.name }}
                </div>
                <div class="text-xs text-gray-500 mb-4">
                  {{ selectedComponentForEdit.path }}
                </div>
              </div>
              
              <div class="relative">
                <textarea
                  v-model="componentEditContent"
                  class="w-full h-96 font-mono text-sm border border-gray-300 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-900 text-green-400"
                  placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞..."
                  style="tab-size: 2;"
                  spellcheck="false"
                  @input="updateLivePreview"
                />
                <div class="absolute top-2 right-2 text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded">
                  Vue Component
                </div>
              </div>

              <div class="flex space-x-2">
                <button
                  :disabled="savingComponentEdit"
                  class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50"
                  @click="saveComponentEdit"
                >
                  {{ savingComponentEdit ? 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
                </button>
                <button
                  class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
                  @click="reloadComponentEdit"
                >
                  üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
                <button
                  class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
                  @click="resetComponentEdit"
                >
                  ‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å
                </button>
              </div>

              <div
                v-if="componentEditMessage"
                :class="['p-2 rounded', componentEditMessage.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800']"
              >
                {{ componentEditMessage.text }}
              </div>
            </div>
            <div
              v-else
              class="text-gray-500 text-center py-12"
            >
              –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            </div>
          </div>

          <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: Live Preview -->
          <div class="lg:col-span-1 border border-gray-300 rounded-lg p-4">
            <h3 class="font-bold mb-4">
              üëÅÔ∏è Live Preview
            </h3>
            <div class="mb-4 flex items-center justify-between">
              <label class="flex items-center space-x-2">
                <input
                  v-model="autoPreview"
                  type="checkbox"
                  class="rounded"
                >
                <span class="text-sm">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
              </label>
              <button
                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                @click="refreshPreview"
              >
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
            <div class="border border-gray-200 rounded p-4 bg-gray-50 min-h-96 max-h-96 overflow-auto">
              <div
                v-if="livePreviewContent"
                v-html="livePreviewContent"
              />
              <div
                v-else
                class="text-gray-500 text-center py-12"
              >
                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
              </div>
            </div>
          </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
        <div class="mt-6 border-t border-gray-300 pt-6">
          <h3 class="font-bold mb-4">
            üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <button
              class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
              @click="exportComponent"
            >
              üì• –≠–∫—Å–ø–æ—Ä—Ç
            </button>
            <button
              class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
              @click="importComponent"
            >
              üì§ –ò–º–ø–æ—Ä—Ç
            </button>
            <button
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
              @click="validateComponent"
            >
              ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è
            </button>
            <button
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              @click="formatComponent"
            >
              üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, nextTick, watch } from 'vue'
import { useRouter } from 'vue-router'
import { logger } from '@/utils/logger'
import { adminWsService } from '@/services/adminWebSocket'

const router = useRouter()
const admin = ref(null)
const activeTab = ref('files')

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏
const filePath = ref('')
const fileList = ref([])
const selectedFile = ref(null)
const currentFileContent = ref('')
const saving = ref(false)
const saveMessage = ref(null)

// –°–∏—Å—Ç–µ–º–∞
const customCommand = ref('')
const commandResult = ref('')

// –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
const sqlQuery = ref('')
const sqlResult = ref('')
const dbStats = ref(null)

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
const users = ref([])

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
const systemInfo = ref({ memory: null, disk: null, cpu: null })

// –¢–µ—Ä–º–∏–Ω–∞–ª
const terminalLines = ref([])
const terminalInput = ref('')
const terminalPrompt = ref('$ ')
const terminalConnected = ref(false)
const terminalOutput = ref(null)

// –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
const vueComponents = ref([])
const selectedComponent = ref(null)
const componentContent = ref('')
const savingComponent = ref(false)
const componentSaveMessage = ref(null)
const showPreview = ref(false)
const previewContent = ref('')

// –ù–æ–≤—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –∂–∏–≤—ã–º –ø—Ä–µ–≤—å—é
const siteUrl = ref(window.location.origin)
const previewPage = ref('/')
const previewIframe = ref(null)
const inspectMode = ref(false)
const selectedElement = ref(null)
const editorTab = ref('content')
const editorMessage = ref(null)
const viewportSize = ref('desktop')
const newClassName = ref('')
const editMode = ref(false)
const elementWidth = ref('')
const elementHeight = ref('')
const elementPadding = ref('')
const elementMargin = ref('')
const enableResize = ref(false)
const changeHistory = ref([])
const savingChanges = ref(false)
const isDeploying = ref(false)
const isZoomed = ref(false)

// –°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
const processes = ref(null)
const dockerContainers = ref([])
const realtimeLogs = ref(null)
const selectedLogService = ref('backend')
const gitStatus = ref(null)
const environmentVariables = ref(null)
const activeConnections = ref(null)

// –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const availableComponents = ref([])
const selectedComponentForEdit = ref(null)
const componentEditContent = ref('')
const savingComponentEdit = ref(false)
const componentEditMessage = ref(null)
const livePreviewContent = ref('')
const autoPreview = ref(true)

// –ë—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ
const fileBrowserPath = ref('/home/vmroadhelp')
const fileBrowserItems = ref([])
const selectedFileBrowserItem = ref(null)
const fileBrowserContent = ref('')
const savingFileBrowser = ref(false)
const fileBrowserSaveMessage = ref(null)
const showCreateDirectoryModal = ref(false)
const newDirectoryName = ref('')
const showCreateFileModal = ref(false)
const newFileName = ref('')
const newFileContent = ref('')
const showUploadFileModal = ref(false)
const fileUploadInput = ref(null)

const getToken = () => localStorage.getItem('adminToken')

// –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç HTML –æ—à–∏–±–∫–∏ –æ—Ç nginx)
const safeJsonParse = async (response) => {
  const contentType = response.headers.get('content-type') || ''
  const text = await response.text()
  
  // –ï—Å–ª–∏ —ç—Ç–æ HTML (502, 504 –æ—Ç nginx), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
  if (contentType.includes('text/html') || text.trim().startsWith('<html>')) {
    return { isHtml: true, text, error: text }
  }
  
  // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
  try {
    return { isHtml: false, data: JSON.parse(text) }
  } catch (e) {
    // –ï—Å–ª–∏ –Ω–µ JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ—à–∏–±–∫—É
    return { isHtml: false, text, error: text || `HTTP ${response.status}` }
  }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è JSON –∏–∑ response
const getJsonData = async (response) => {
  if (!response.ok) {
    const parsed = await safeJsonParse(response)
    if (parsed.isHtml) {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã –æ—Ç nginx
      if (parsed.text.includes('502') || parsed.text.includes('Bad Gateway')) {
        throw new Error('Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".')
      } else if (parsed.text.includes('504') || parsed.text.includes('Gateway Time-out')) {
        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
      } else {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ HTML
        const titleMatch = parsed.text.match(/<title>(.*?)<\/title>/i)
        if (titleMatch) {
          throw new Error(titleMatch[1])
        } else {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend.')
        }
      }
    }
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å 502
    if (response.status === 502) {
      throw new Error('Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".')
    }
    throw new Error(parsed.error || parsed.data?.error || parsed.data?.message || `HTTP ${response.status}`)
  }
  
  const parsed = await safeJsonParse(response)
  if (parsed.isHtml) {
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã –æ—Ç nginx (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    if (parsed.text.includes('502') || parsed.text.includes('Bad Gateway')) {
      throw new Error('Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".')
    } else if (parsed.text.includes('504') || parsed.text.includes('Gateway Time-out')) {
      throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
    } else {
      const titleMatch = parsed.text.match(/<title>(.*?)<\/title>/i)
      if (titleMatch) {
        throw new Error(titleMatch[1])
      } else {
        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend.')
      }
    }
  }
  return parsed.data
}

const getFileExtension = (filename) => {
  if (!filename) return ''
  const ext = filename.split('.').pop()?.toLowerCase()
  const extensions = {
    'js': 'JavaScript',
    'vue': 'Vue',
    'ts': 'TypeScript',
    'json': 'JSON',
    'css': 'CSS',
    'html': 'HTML',
    'md': 'Markdown',
    'py': 'Python',
    'sh': 'Shell',
    'sql': 'SQL'
  }
  return extensions[ext] || ext?.toUpperCase() || 'TEXT'
}

const loadFile = async () => {
  if (!filePath.value) {
    alert('–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É')
    return
  }
  try {
    const response = await fetch('/api/v1/super-admin/files/read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: filePath.value })
    })
    const data = await getJsonData(response)
    if (data.success) {
      currentFileContent.value = data.content
      selectedFile.value = { path: filePath.value, name: filePath.value.split('/').pop() }
      saveMessage.value = null
      logger.info('File loaded', { path: filePath.value })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞')
    }
  } catch (error) {
    logger.error('Load file error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message)
  }
}

const listDirectory = async () => {
  const path = filePath.value || '/home/vmroadhelp'
  try {
    const response = await fetch('/api/v1/super-admin/files/list', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path })
    })
    const data = await getJsonData(response)
    if (data.success) {
      fileList.value = data.items || []
      logger.info('Directory listed', { path })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞')
    }
  } catch (error) {
    logger.error('List directory error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞: ' + error.message)
  }
}

const selectFile = (item) => {
  if (item.type === 'directory') {
    filePath.value = item.path
    listDirectory()
  } else {
    filePath.value = item.path
    loadFile()
  }
}

const saveFile = async () => {
  if (!selectedFile.value || !currentFileContent.value) {
    alert('–ù–µ—Ç —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    return
  }
  saving.value = true
  saveMessage.value = null
  try {
    const response = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: selectedFile.value.path,
        content: currentFileContent.value
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      saveMessage.value = { type: 'success', text: '‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω' }
      logger.info('File saved', { path: selectedFile.value.path })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞')
    }
  } catch (error) {
    logger.error('Save file error:', error)
    saveMessage.value = { type: 'error', text: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message }
  } finally {
    saving.value = false
  }
}

const reloadFile = () => {
  if (selectedFile.value) {
    loadFile()
  }
}

const refreshFileList = () => {
  listDirectory()
}

const executeSystemCommand = async (command) => {
  if (!command) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É')
    return
  }
  try {
    const token = getToken()
    if (!token) {
      commandResult.value = '–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω'
      return
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª–≥–æ)
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 60000)
    
    const response = await fetch('/api/v1/super-admin/system/execute', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ command }),
      signal: controller.signal
    })
    clearTimeout(timeoutId)
    
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || data.error || '‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ'
      logger.info('System command executed', { command })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –Ω–æ –µ—Å—Ç—å message, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (error?.message) {
          errorMessage = error.message
        } else {
          errorMessage = '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'
        }
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
    if (errorMessage.includes('{"error":') || errorMessage.includes('{"message":')) {
      try {
        const jsonMatch = errorMessage.match(/\{.*\}/)
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0])
          if (parsed.message) {
            errorMessage = parsed.message
          } else if (parsed.error && typeof parsed.error === 'string') {
            errorMessage = parsed.error
          }
        }
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π —Ç–∞–π–º–∞—É—Ç–∞ (504 Gateway Timeout –∏–ª–∏ AbortError)
    if (errorMessage.includes('504') || 
        errorMessage.includes('Gateway Timeout') || 
        errorMessage.includes('Gateway Time-out') ||
        errorMessage.includes('AbortError') ||
        error?.name === 'AbortError') {
      errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (60 —Å–µ–∫—É–Ω–¥). –ö–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∏–ª–∏ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.'
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π "–∫–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    if (errorMessage.includes('not found') || errorMessage.includes('Command failed')) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (errorMessage.includes('docker') && errorMessage.includes('not found')) {
        errorMessage = '–ö–æ–º–∞–Ω–¥–∞ docker –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ Alpine Linux (–Ω–∞–ø—Ä–∏–º–µ—Ä: ls, ps, cat, grep, find).'
      } else if (errorMessage.includes('systemctl') && errorMessage.includes('not found')) {
        errorMessage = '–ö–æ–º–∞–Ω–¥–∞ systemctl –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ Alpine Linux.'
      } else if (errorMessage.includes('Command failed:')) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        const commandMatch = errorMessage.match(/Command failed: (.+?)(?:\n|\r|$)/)
        if (commandMatch) {
          const failedCommand = commandMatch[1].trim()
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã
          if (failedCommand.startsWith('docker')) {
            errorMessage = '–ö–æ–º–∞–Ω–¥–∞ docker –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ Alpine Linux.'
          } else if (failedCommand.startsWith('systemctl')) {
            errorMessage = '–ö–æ–º–∞–Ω–¥–∞ systemctl –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ Alpine Linux.'
          } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            errorMessage = `–ö–æ–º–∞–Ω–¥–∞ "${failedCommand}" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.`
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–æ–º–∞–Ω–¥—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          errorMessage = '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ Alpine Linux.'
        }
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π —Ç–∞–π–º–∞—É—Ç–∞ (504 Gateway Timeout –∏–ª–∏ AbortError)
    if (errorMessage.includes('504') || 
        errorMessage.includes('Gateway Timeout') || 
        errorMessage.includes('Gateway Time-out') ||
        errorMessage.includes('AbortError') ||
        error?.name === 'AbortError') {
      errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (60 —Å–µ–∫—É–Ω–¥). –ö–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∏–ª–∏ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.'
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã (504 Gateway Timeout –æ—Ç nginx)
    if (errorMessage.includes('<html>') || errorMessage.includes('<title>')) {
      if (errorMessage.includes('504') || errorMessage.includes('Gateway Time-out')) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (60 —Å–µ–∫—É–Ω–¥). –ö–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∏–ª–∏ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.'
      } else {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ HTML
        const titleMatch = errorMessage.match(/<title>(.*?)<\/title>/i)
        if (titleMatch) {
          errorMessage = titleMatch[1]
        } else {
          errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã.'
        }
      }
    }
    
    logger.error('Execute command error:', { error, message: errorMessage, command })
    commandResult.value = '–û—à–∏–±–∫–∞: ' + errorMessage
  }
}

const getDatabaseStats = async () => {
  try {
    const token = getToken()
    if (!token) {
      logger.warn('No token available for getDatabaseStats')
      alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.')
      router.push('/admin/login')
      return
    }
    
    const response = await fetch('/api/v1/super-admin/database/stats', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('adminToken')
        localStorage.removeItem('admin')
        router.push('/admin/login')
        return
      }
    }
    
    const data = await getJsonData(response)
    if (data.success) {
      dbStats.value = data.stats
      logger.info('Database stats loaded successfully')
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã (502 Bad Gateway, 504 Gateway Timeout –æ—Ç nginx)
    if (errorMessage.includes('<html>') || errorMessage.includes('<title>')) {
      if (errorMessage.includes('502') || errorMessage.includes('Bad Gateway')) {
        errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
      } else if (errorMessage.includes('504') || errorMessage.includes('Gateway Time-out')) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
      } else {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ HTML
        const titleMatch = errorMessage.match(/<title>(.*?)<\/title>/i)
        if (titleMatch) {
          errorMessage = titleMatch[1]
        } else {
          errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend.'
        }
      }
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–∞ "HTTP 502"
    if (errorMessage.includes('HTTP 502') || errorMessage.includes('502')) {
      errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
    }
    
    logger.error('Get database stats error:', { error, message: errorMessage })
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ë–î: ' + errorMessage)
  }
}

const executeSQL = async () => {
  if (!sqlQuery.value) {
    alert('–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å')
    return
  }
  try {
    const response = await fetch('/api/v1/super-admin/database/query', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ query: sqlQuery.value })
    })
    if (!response.ok) {
      // –î–ª—è 403 –ø–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      if (response.status === 403) {
        const parsed = await safeJsonParse(response)
        const errorMessage = parsed.error || parsed.data?.error || parsed.data?.message || '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'
        throw new Error(errorMessage)
      }
      // –î–ª—è 502 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
      if (response.status === 502) {
        throw new Error('Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".')
      }
      throw new Error(`HTTP ${response.status}`)
    }
    const data = await getJsonData(response)
    if (data.success) {
      sqlResult.value = JSON.stringify(data.result, null, 2)
      logger.info('SQL query executed', { query: sqlQuery.value })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ SELECT, SHOW, DESCRIBE, EXPLAIN –∑–∞–ø—Ä–æ—Å—ã.'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ "HTTP 403", –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–æ–Ω—è—Ç–Ω–æ–µ
    if (errorMessage === 'HTTP 403' || errorMessage.includes('HTTP 403')) {
      errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ SELECT, SHOW, DESCRIBE, EXPLAIN –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.'
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–∞ "HTTP 502"
    if (errorMessage.includes('HTTP 502') || (errorMessage.includes('502') && !errorMessage.includes('Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'))) {
      errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
    }
    
    logger.error('Execute SQL error:', { error, message: errorMessage })
    sqlResult.value = '–û—à–∏–±–∫–∞: ' + errorMessage
  }
}

const loadUsers = async () => {
  try {
    const token = getToken()
    if (!token) {
      logger.warn('No token available for loadUsers')
      alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.')
      router.push('/admin/login')
      return
    }
    
    const response = await fetch('/api/v1/admin/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('adminToken')
        localStorage.removeItem('admin')
        router.push('/admin/login')
        return
      }
    }
    
    const data = await getJsonData(response)
    if (data.success) {
      users.value = data.users || []
      logger.info('Users loaded successfully', { count: users.value.length })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã (502 Bad Gateway, 504 Gateway Timeout –æ—Ç nginx)
    if (errorMessage.includes('<html>') || errorMessage.includes('<title>')) {
      if (errorMessage.includes('502') || errorMessage.includes('Bad Gateway')) {
        errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
      } else if (errorMessage.includes('504') || errorMessage.includes('Gateway Time-out')) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
      } else {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ HTML
        const titleMatch = errorMessage.match(/<title>(.*?)<\/title>/i)
        if (titleMatch) {
          errorMessage = titleMatch[1]
        } else {
          errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend.'
        }
      }
    }
    
    logger.error('Load users error:', { error, message: errorMessage })
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + errorMessage)
  }
}

const editUser = (user) => {
  alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + user.email)
  // TODO: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
}

const deleteUser = async (userId) => {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return
  try {
    const response = await fetch(`/api/v1/admin/users/${userId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      await loadUsers()
      logger.info('User deleted', { userId })
    } else {
      throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è')
    }
  } catch (error) {
    logger.error('Delete user error:', error)
    alert('–û—à–∏–±–∫–∞: ' + error.message)
  }
}

// ========== –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å—ã ==========
const getPremiumIcon = (status) => {
  switch (status) {
    case 'gold': return 'ü•á'
    case 'silver': return 'ü•à'
    case 'bronze': return 'ü•â'
    default: return ''
  }
}

const getPremiumNameClass = (status) => {
  switch (status) {
    case 'gold': return 'font-bold text-yellow-600'
    case 'silver': return 'font-semibold text-gray-500'
    case 'bronze': return 'font-medium text-orange-700'
    default: return ''
  }
}

const getPremiumSelectClass = (status) => {
  switch (status) {
    case 'gold': return 'bg-yellow-100 border-yellow-400 text-yellow-800'
    case 'silver': return 'bg-gray-100 border-gray-400 text-gray-700'
    case 'bronze': return 'bg-orange-100 border-orange-400 text-orange-800'
    default: return 'bg-white border-gray-300'
  }
}

const setPremiumStatus = async (userId, status) => {
  try {
    const premiumStatus = status === '' ? null : status
    const statusName = status === 'gold' ? '–ó–æ–ª–æ—Ç–æ–π' : 
                        status === 'silver' ? '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π' : 
                        status === 'bronze' ? '–ë—Ä–æ–Ω–∑–æ–≤—ã–π' : '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞'
    
    const response = await fetch(`/api/v1/admin/users/${userId}/premium`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        premium_status: premiumStatus,
        expires_at: null // –ë–µ—Å—Å—Ä–æ—á–Ω–æ
      })
    })
    
    const data = await getJsonData(response)
    if (data.success) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
      const userIndex = users.value.findIndex(u => u.id === userId)
      if (userIndex !== -1) {
        users.value[userIndex].premium_status = premiumStatus
      }
      logger.info('Premium status updated', { userId, status: premiumStatus })
      alert(`‚úÖ –°—Ç–∞—Ç—É—Å "${statusName}" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`)
    } else {
      throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞')
    }
  } catch (error) {
    logger.error('Set premium status error:', error)
    alert('–û—à–∏–±–∫–∞: ' + error.message)
    // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    await loadUsers()
  }
}

const getSystemInfo = async (type) => {
  try {
    const response = await fetch(`/api/v1/super-admin/system/info/${type}`, {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      systemInfo.value[type] = data.info
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏')
    }
  } catch (error) {
    logger.error('Get system info error:', error)
    alert('–û—à–∏–±–∫–∞: ' + error.message)
  }
}

const logout = () => {
  localStorage.removeItem('adminToken')
  localStorage.removeItem('admin')
  router.push('/admin/login')
}

const goToHome = () => {
  router.push('/')
}

const goToDashboard = () => {
  router.push('/admin/dashboard')
}

// –¢–µ—Ä–º–∏–Ω–∞–ª
const connectTerminal = () => {
  const token = getToken()
  if (!token) {
    alert('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
    return
  }

  adminWsService.connect(token)

  adminWsService.onTerminalOutput((data) => {
    terminalLines.value.push({ type: data.type, data: data.data })
    nextTick(() => {
      if (terminalOutput.value) {
        terminalOutput.value.scrollTop = terminalOutput.value.scrollHeight
      }
    })
  })

  adminWsService.onTerminalError((data) => {
    terminalLines.value.push({ type: 'error', data: `‚ùå –û—à–∏–±–∫–∞: ${data.message}` })
    nextTick(() => {
      if (terminalOutput.value) {
        terminalOutput.value.scrollTop = terminalOutput.value.scrollHeight
      }
    })
  })

  adminWsService.onTerminalClose((data) => {
    terminalLines.value.push({ type: 'info', data: `\n‚úÖ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –∫–æ–¥–æ–º: ${data.code}` })
    terminalPrompt.value = '$ '
    nextTick(() => {
      if (terminalOutput.value) {
        terminalOutput.value.scrollTop = terminalOutput.value.scrollHeight
      }
    })
  })

  adminWsService.socket?.on('connect', () => {
    terminalConnected.value = true
    terminalLines.value.push({ type: 'info', data: '‚úÖ –¢–µ—Ä–º–∏–Ω–∞–ª –ø–æ–¥–∫–ª—é—á–µ–Ω\n' })
  })

  adminWsService.socket?.on('disconnect', () => {
    terminalConnected.value = false
    terminalLines.value.push({ type: 'info', data: '‚ùå –¢–µ—Ä–º–∏–Ω–∞–ª –æ—Ç–∫–ª—é—á–µ–Ω\n' })
  })

  terminalConnected.value = adminWsService.isConnected
}

const executeTerminalCommand = () => {
  if (!terminalInput.value.trim()) return

  const command = terminalInput.value
  terminalLines.value.push({ type: 'input', data: `${terminalPrompt.value}${command}` })
  terminalInput.value = ''
  terminalPrompt.value = ''

  adminWsService.sendTerminalCommand(command)
}

const clearTerminal = () => {
  terminalLines.value = []
  terminalInput.value = ''
  terminalPrompt.value = '$ '
}

// –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
const refreshComponents = async () => {
  try {
    const token = getToken()
    if (!token) {
      logger.warn('No token available for refreshComponents')
      return
    }

    // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—É—Ç–µ–π (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - views, –≥–¥–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
    const possiblePaths = [
      '/home/vmroadhelp/frontend/src/views',
      '/home/vmroadhelp/frontend/src/components',
      '/home/vmroadhelp/roadhelp/frontend/src/views',
      '/app/frontend/src/views',
      '/home/vmroadhelp'
    ]

    let lastError = null
    let allComponents = []
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø—É—Ç–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    for (const path of possiblePaths) {
      try {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (30 —Å–µ–∫—É–Ω–¥)
        const controller = new AbortController()
        const timeoutId = setTimeout(() => controller.abort(), 30000)
        
        const response = await fetch('/api/v1/super-admin/files/list', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path }),
          signal: controller.signal
        })
        clearTimeout(timeoutId)
        const data = await getJsonData(response)
        if (data.success && data.items) {
          const components = (data.items || [])
            .filter(item => item.type === 'file' && item.name.endsWith('.vue'))
            .map(item => ({
              name: item.name,
              path: item.path
            }))
          allComponents.push(...components)
          logger.info('Found components in path', { count: components.length, path })
        }
      } catch (pathError) {
        lastError = pathError
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –ø—É—Ç—å
        continue
      }
    }
    
    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ path
    const uniqueComponents = Array.from(
      new Map(allComponents.map(c => [c.path, c])).values()
    )
    
    if (uniqueComponents.length > 0) {
      vueComponents.value = uniqueComponents
      logger.info('Components refreshed successfully', { total: uniqueComponents.length })
      return
    }

    // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –ø—É—Ç—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (lastError) {
      throw lastError
    } else {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π "–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    if (errorMessage.includes('ENOENT') || errorMessage.includes('no such file or directory')) {
      errorMessage = '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Vue –º–æ–≥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥—Ä—É–≥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.'
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML –æ—Ç–≤–µ—Ç—ã (502 Bad Gateway, 504 Gateway Timeout –æ—Ç nginx)
    if (errorMessage.includes('<html>') || errorMessage.includes('<title>')) {
      if (errorMessage.includes('502') || errorMessage.includes('Bad Gateway')) {
        errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
      } else if (errorMessage.includes('504') || errorMessage.includes('Gateway Time-out')) {
        errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (30 —Å–µ–∫—É–Ω–¥). –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.'
      } else {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ HTML
        const titleMatch = errorMessage.match(/<title>(.*?)<\/title>/i)
        if (titleMatch) {
          errorMessage = titleMatch[1]
        } else {
          errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend.'
        }
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π —Ç–∞–π–º–∞—É—Ç–∞ (504 Gateway Timeout –∏–ª–∏ AbortError)
    if (errorMessage.includes('504') || 
        errorMessage.includes('Gateway Timeout') || 
        errorMessage.includes('Gateway Time-out') ||
        errorMessage.includes('AbortError') ||
        error?.name === 'AbortError') {
      errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (30 —Å–µ–∫—É–Ω–¥). –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.'
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π 502 Bad Gateway
    if (errorMessage.includes('502') || errorMessage.includes('Bad Gateway')) {
      errorMessage = 'Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (502 Bad Gateway). –í–æ–∑–º–æ–∂–Ω–æ, backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∏—Å—Ç–µ–º–æ–π".'
    }
    
    logger.error('Refresh components error:', { error, message: errorMessage })
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
    if (vueComponents.value.length === 0) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', errorMessage)
    } else {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: ' + errorMessage)
    }
  }
}

const loadComponentForEdit = async (component) => {
  selectedComponent.value = component
  try {
    const response = await fetch('/api/v1/super-admin/files/read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: component.path })
    })
    const data = await getJsonData(response)
    if (data.success) {
      componentContent.value = data.content
      componentSaveMessage.value = null
    }
  } catch (error) {
    logger.error('Load component error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: ' + error.message)
  }
}

const saveComponent = async () => {
  if (!selectedComponent.value) return

  savingComponent.value = true
  componentSaveMessage.value = null

  try {
    const response = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: selectedComponent.value.path,
        content: componentContent.value
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      componentSaveMessage.value = { type: 'success', text: '‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω' }
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    }
  } catch (error) {
    logger.error('Save component error:', error)
    componentSaveMessage.value = { type: 'error', text: '‚ùå –û—à–∏–±–∫–∞: ' + error.message }
  } finally {
    savingComponent.value = false
  }
}

const updatePreview = () => {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  if (showPreview.value) {
    const templateMatch = componentContent.value.match(/<template>([\s\S]*?)<\/template>/)
    if (templateMatch) {
      previewContent.value = templateMatch[1]
    }
  }
}

const previewComponent = () => {
  // –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ template —á–∞—Å—Ç—å
  const templateMatch = componentContent.value.match(/<template>([\s\S]*?)<\/template>/)
  if (templateMatch) {
    previewContent.value = templateMatch[1]
    showPreview.value = true
  } else {
    alert('–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ <template> –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ')
  }
}

// –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å –∂–∏–≤—ã–º –ø—Ä–µ–≤—å—é
const refreshPreview = () => {
  if (previewIframe.value) {
    previewIframe.value.src = previewIframe.value.src
  }
}

const toggleInspectMode = () => {
  inspectMode.value = !inspectMode.value
  if (inspectMode.value && previewIframe.value) {
    setupInspectMode()
  }
}

const setupInspectMode = () => {
  try {
    const iframeDoc = previewIframe.value?.contentDocument || previewIframe.value?.contentWindow?.document
    if (!iframeDoc) return

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    let style = iframeDoc.getElementById('visual-editor-highlight')
    if (!style) {
      style = iframeDoc.createElement('style')
      style.id = 'visual-editor-highlight'
      style.textContent = `
        .visual-editor-highlight {
          outline: 2px dashed #3b82f6 !important;
          outline-offset: 2px !important;
          cursor: pointer !important;
        }
        .visual-editor-selected {
          outline: 3px solid #10b981 !important;
          outline-offset: 2px !important;
        }
      `
      iframeDoc.head.appendChild(style)
    }

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    iframeDoc.body.removeEventListener('mouseover', handleMouseOver)
    iframeDoc.body.removeEventListener('mouseout', handleMouseOut)
    iframeDoc.body.removeEventListener('click', handleElementClick)

    if (inspectMode.value) {
      iframeDoc.body.addEventListener('mouseover', handleMouseOver)
      iframeDoc.body.addEventListener('mouseout', handleMouseOut)
      iframeDoc.body.addEventListener('click', handleElementClick)
    }
  } catch (error) {
    console.error('Error setting up inspect mode:', error)
  }
}

const handleMouseOver = (e) => {
  if (!inspectMode.value) return
  e.stopPropagation()
  e.target.classList.add('visual-editor-highlight')
}

const handleMouseOut = (e) => {
  if (!inspectMode.value) return
  e.stopPropagation()
  e.target.classList.remove('visual-editor-highlight')
}

const handleElementClick = (e) => {
  if (!inspectMode.value) return
  e.preventDefault()
  e.stopPropagation()
  
  const element = e.target
  
  // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
  const iframeDoc = previewIframe.value?.contentDocument
  if (iframeDoc) {
    iframeDoc.querySelectorAll('.visual-editor-selected').forEach(el => {
      el.classList.remove('visual-editor-selected')
    })
  }
  
  element.classList.add('visual-editor-selected')
  element.classList.remove('visual-editor-highlight')
  
  // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ
  const computedStyle = window.getComputedStyle(element)
  const styles = {}
  const importantStyles = ['color', 'background-color', 'font-size', 'font-weight', 'padding', 'margin', 'border', 'width', 'height', 'display', 'flex-direction']
  
  importantStyles.forEach(prop => {
    const value = computedStyle.getPropertyValue(prop)
    if (value) styles[prop] = value
  })
  
  selectedElement.value = {
    tagName: element.tagName.toLowerCase(),
    selector: getElementSelector(element),
    textContent: element.textContent || '',
    innerHTML: element.innerHTML || '',
    classes: Array.from(element.classList).filter(c => !c.startsWith('visual-editor')),
    styles: styles,
    element: element
  }
  
  editorTab.value = 'content'
  editorMessage.value = null
}

const getElementSelector = (element) => {
  if (element.id) return `#${element.id}`
  
  let selector = element.tagName.toLowerCase()
  if (element.className) {
    const classes = Array.from(element.classList)
      .filter(c => !c.startsWith('visual-editor'))
      .join('.')
    if (classes) selector += `.${classes}`
  }
  
  return selector
}

const updateElementContent = () => {
  if (selectedElement.value?.element) {
    selectedElement.value.element.textContent = selectedElement.value.textContent
  }
}

const updateElementHTML = () => {
  if (selectedElement.value?.element) {
    selectedElement.value.element.innerHTML = selectedElement.value.innerHTML
  }
}

const updateElementStyle = (property) => {
  if (selectedElement.value?.element) {
    selectedElement.value.element.style[property] = selectedElement.value.styles[property]
  }
}

const addNewStyle = () => {
  const property = prompt('–í–≤–µ–¥–∏—Ç–µ CSS —Å–≤–æ–π—Å—Ç–≤–æ (background-color, font-size, –∏ —Ç.–¥.):')
  if (property && selectedElement.value) {
    selectedElement.value.styles[property] = ''
  }
}

const addClass = () => {
  if (newClassName.value && selectedElement.value) {
    selectedElement.value.classes.push(newClassName.value)
    if (selectedElement.value.element) {
      selectedElement.value.element.classList.add(newClassName.value)
    }
    newClassName.value = ''
  }
}

const removeClass = (className) => {
  if (selectedElement.value) {
    selectedElement.value.classes = selectedElement.value.classes.filter(c => c !== className)
    if (selectedElement.value.element) {
      selectedElement.value.element.classList.remove(className)
    }
  }
}

const saveChangesToFile = async () => {
  if (!selectedElement.value) {
    editorMessage.value = { type: 'error', text: '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è' }
    return
  }
  
  // –ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ iframe
  const iframeDoc = previewIframe.value?.contentDocument
  if (!iframeDoc) {
    editorMessage.value = { type: 'error', text: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    return
  }
  
  savingChanges.value = true
  editorMessage.value = null
  
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ URL
    let componentPath = ''
    const currentPath = previewPage.value
    
    // –ú–∞–ø–ø–∏–Ω–≥ URL -> Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    const pathMapping = {
      '/': '/home/vmroadhelp/frontend/src/views/HomeView.vue',
      '/map': '/home/vmroadhelp/frontend/src/views/MapView.vue',
      '/profile': '/home/vmroadhelp/frontend/src/views/ProfileView.vue',
      '/admin/dashboard': '/home/vmroadhelp/frontend/src/views/AdminDashboard.vue'
    }
    
    componentPath = pathMapping[currentPath]
    
    if (!componentPath) {
      editorMessage.value = { 
        type: 'error', 
        text: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ' + currentPath
      }
      return
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Ñ–∞–π–ª–∞
    const readResponse = await fetch('/api/v1/super-admin/files/read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: componentPath })
    })
    
    const readData = await getJsonData(readResponse)
    if (!readData.success) {
      throw new Error(readData.error || '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞')
    }
    
    let fileContent = readData.content
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º <template> —Å–µ–∫—Ü–∏—é
    const templateMatch = fileContent.match(/<template>([\s\S]*?)<\/template>/)
    if (!templateMatch) {
      throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ <template> –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ')
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML –∏–∑ iframe (body –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
    const appElement = iframeDoc.querySelector('#app') || iframeDoc.body
    const updatedHTML = appElement.innerHTML
    
    // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ <template>
    const newFileContent = fileContent.replace(
      /<template>[\s\S]*?<\/template>/,
      `<template>
  <div id="app">
${updatedHTML}
  </div>
</template>`
    )
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    const writeResponse = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: componentPath,
        content: newFileContent
      })
    })
    
    const writeData = await getJsonData(writeResponse)
    if (!writeData.success) {
      throw new Error(writeData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    }
    
    editorMessage.value = {
      type: 'success',
      text: '‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å frontend –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "üöÄ –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å"'
    }
    
    logger.info('Visual changes saved to file', { 
      path: componentPath,
      selector: selectedElement.value.selector 
    })
  } catch (error) {
    logger.error('Save visual changes error:', error)
    editorMessage.value = {
      type: 'error',
      text: '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message
    }
  } finally {
    savingChanges.value = false
  }
}

const resetElement = () => {
  if (selectedElement.value?.element) {
    selectedElement.value.element.classList.remove('visual-editor-selected')
  }
  selectedElement.value = null
  editorMessage.value = null
  refreshPreview()
}

const onIframeLoad = () => {
  if (inspectMode.value) {
    setTimeout(() => setupInspectMode(), 500)
  }
  if (editMode.value) {
    setTimeout(() => setupEditMode(), 500)
  }
}

const setViewportSize = (size) => {
  viewportSize.value = size
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–∞–∑–º–µ—Ä–∞
  if (size !== 'mobile') {
    isZoomed.value = false
  }
}

const toggleZoom = () => {
  isZoomed.value = !isZoomed.value
}

const clearCache = () => {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?')) {
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => caches.delete(name))
      })
    }
    window.location.reload(true)
  }
}

const exportChanges = () => {
  if (!selectedElement.value) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞')
    return
  }
  
  const changes = {
    selector: selectedElement.value.selector,
    styles: selectedElement.value.styles,
    classes: selectedElement.value.classes,
    innerHTML: selectedElement.value.innerHTML
  }
  
  const blob = new Blob([JSON.stringify(changes, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `visual-changes-${Date.now()}.json`
  a.click()
  URL.revokeObjectURL(url)
}

// –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const toggleEditMode = () => {
  editMode.value = !editMode.value
  if (editMode.value && previewIframe.value) {
    setupEditMode()
  }
}

const setupEditMode = () => {
  try {
    const iframeDoc = previewIframe.value?.contentDocument || previewIframe.value?.contentWindow?.document
    if (!iframeDoc) return

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è drag-and-drop –∏ resize
    let style = iframeDoc.getElementById('visual-editor-dragdrop')
    if (!style) {
      style = iframeDoc.createElement('style')
      style.id = 'visual-editor-dragdrop'
      style.textContent = `
        body {
          position: relative !important;
        }
        
        .visual-editor-draggable {
          cursor: move !important;
          position: relative !important;
          min-height: 30px !important;
          min-width: 30px !important;
          outline: 1px dashed rgba(139, 92, 246, 0.3) !important;
          outline-offset: 2px !important;
        }
        .visual-editor-draggable:hover {
          outline: 2px dashed rgba(139, 92, 246, 0.6) !important;
          background: rgba(139, 92, 246, 0.05) !important;
          z-index: 10 !important;
        }
        .visual-editor-dragging {
          opacity: 0.6 !important;
          z-index: 9999 !important;
          cursor: grabbing !important;
        }
        .visual-editor-absolute {
          position: absolute !important;
        }
        .visual-editor-selected {
          outline: 3px solid #3b82f6 !important;
          outline-offset: 3px !important;
          background: rgba(59, 130, 246, 0.1) !important;
          z-index: 100 !important;
        }
        /* Resize handles */
        .visual-editor-resize-handle {
          position: absolute !important;
          width: 10px !important;
          height: 10px !important;
          background: #3b82f6 !important;
          border: 2px solid white !important;
          z-index: 10001 !important;
          pointer-events: auto !important;
        }
        .visual-editor-resize-handle.nw { top: -5px !important; left: -5px !important; cursor: nw-resize !important; }
        .visual-editor-resize-handle.ne { top: -5px !important; right: -5px !important; cursor: ne-resize !important; }
        .visual-editor-resize-handle.sw { bottom: -5px !important; left: -5px !important; cursor: sw-resize !important; }
        .visual-editor-resize-handle.se { bottom: -5px !important; right: -5px !important; cursor: se-resize !important; }
        .visual-editor-resize-handle.n { top: -5px !important; left: 50% !important; margin-left: -5px !important; cursor: n-resize !important; }
        .visual-editor-resize-handle.s { bottom: -5px !important; left: 50% !important; margin-left: -5px !important; cursor: s-resize !important; }
        .visual-editor-resize-handle.w { top: 50% !important; left: -5px !important; margin-top: -5px !important; cursor: w-resize !important; }
        .visual-editor-resize-handle.e { top: 50% !important; right: -5px !important; margin-top: -5px !important; cursor: e-resize !important; }
        /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
          .visual-editor-draggable {
            min-height: 44px !important;
            padding: 8px !important;
          }
          .visual-editor-resize-handle {
            width: 16px !important;
            height: 16px !important;
          }
        }
      `
      iframeDoc.head.appendChild(style)
    }
    
    // –î–µ–ª–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º–∏
    const elements = iframeDoc.querySelectorAll('button, a, input, h1, h2, h3, p, div, img')
    elements.forEach((el) => {
      if (!el.getAttribute('draggable') && el.tagName !== 'SCRIPT' && el.tagName !== 'STYLE' && el.tagName !== 'HTML' && el.tagName !== 'BODY') {
        el.setAttribute('draggable', 'true')
        el.classList.add('visual-editor-draggable')
        
        // Mouse events –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        el.addEventListener('mousedown', handleMouseDown)
      }
    })
    
  } catch (error) {
    console.error('Error setting up edit mode:', error)
  }
}



// –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏ resize
let draggedElement = null
let resizingElement = null
let resizeHandle = null
let dragStartX = 0
let dragStartY = 0
let elementStartX = 0
let elementStartY = 0
let elementStartWidth = 0
let elementStartHeight = 0
let isFreeDragging = false

const handleMouseDown = (e) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ resize handle
  if (e.target.classList.contains('visual-editor-resize-handle')) {
    e.preventDefault()
    e.stopPropagation()
    startResize(e)
    return
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º Ctrl/Cmd - —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault()
    e.stopPropagation()
    startFreeDrag(e)
    return
  }
  
  // –í—ã–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞ (–±–µ–∑ preventDefault, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è)
  selectElement(e.target)
}

const startFreeDrag = (e) => {
  const iframeDoc = previewIframe.value?.contentDocument
  if (!iframeDoc) return
  
  draggedElement = e.target
  isFreeDragging = true
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
  dragStartX = e.clientX
  dragStartY = e.clientY
  
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ absolute, –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç
  if (!draggedElement.classList.contains('visual-editor-absolute')) {
    const rect = draggedElement.getBoundingClientRect()
    const iframeRect = iframeDoc.documentElement.getBoundingClientRect()
    const scrollTop = iframeDoc.documentElement.scrollTop || iframeDoc.body.scrollTop
    const scrollLeft = iframeDoc.documentElement.scrollLeft || iframeDoc.body.scrollLeft
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
    draggedElement.setAttribute('data-original-position', window.getComputedStyle(draggedElement).position)
    draggedElement.setAttribute('data-original-display', window.getComputedStyle(draggedElement).display)
    
    draggedElement.classList.add('visual-editor-absolute')
    draggedElement.style.position = 'absolute'
    draggedElement.style.left = (rect.left - iframeRect.left + scrollLeft) + 'px'
    draggedElement.style.top = (rect.top - iframeRect.top + scrollTop) + 'px'
    draggedElement.style.width = rect.width + 'px'
    draggedElement.style.height = rect.height + 'px'
    draggedElement.style.margin = '0' // –£–±–∏—Ä–∞–µ–º margin —á—Ç–æ–±—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ —Ç–æ—á–Ω—ã–º
    
    // –î–æ–±–∞–≤–ª—è–µ–º resize handles —Å—Ä–∞–∑—É
    addResizeHandles(draggedElement)
  }
  
  elementStartX = parseInt(draggedElement.style.left) || 0
  elementStartY = parseInt(draggedElement.style.top) || 0
  
  draggedElement.classList.add('visual-editor-dragging')
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  iframeDoc.addEventListener('mousemove', handleFreeMove)
  iframeDoc.addEventListener('mouseup', endFreeDrag)
  
  // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º selectedElement
  selectElement(draggedElement)
}

const handleFreeMove = (e) => {
  if (!draggedElement || !isFreeDragging) return
  
  const deltaX = e.clientX - dragStartX
  const deltaY = e.clientY - dragStartY
  
  draggedElement.style.left = (elementStartX + deltaX) + 'px'
  draggedElement.style.top = (elementStartY + deltaY) + 'px'
}

const endFreeDrag = (e) => {
  if (!draggedElement) return
  
  const iframeDoc = previewIframe.value?.contentDocument
  if (iframeDoc) {
    iframeDoc.removeEventListener('mousemove', handleFreeMove)
    iframeDoc.removeEventListener('mouseup', endFreeDrag)
  }
  
  draggedElement.classList.remove('visual-editor-dragging')
  
  if (isFreeDragging) {
    addToHistory('move', draggedElement)
    editorMessage.value = { type: 'success', text: '‚úÖ –≠–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω' }
  }
  
  draggedElement = null
  isFreeDragging = false
}

const startResize = (e) => {
  resizingElement = e.target.parentElement
  resizeHandle = e.target.dataset.handle
  
  dragStartX = e.clientX
  dragStartY = e.clientY
  elementStartX = parseInt(resizingElement.style.left) || 0
  elementStartY = parseInt(resizingElement.style.top) || 0
  elementStartWidth = resizingElement.offsetWidth
  elementStartHeight = resizingElement.offsetHeight
  
  const iframeDoc = previewIframe.value?.contentDocument
  if (iframeDoc) {
    iframeDoc.addEventListener('mousemove', handleResize)
    iframeDoc.addEventListener('mouseup', endResize)
  }
}

const handleResize = (e) => {
  if (!resizingElement || !resizeHandle) return
  
  const deltaX = e.clientX - dragStartX
  const deltaY = e.clientY - dragStartY
  
  switch (resizeHandle) {
    case 'se': // –ü—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π
      resizingElement.style.width = (elementStartWidth + deltaX) + 'px'
      resizingElement.style.height = (elementStartHeight + deltaY) + 'px'
      break
    case 'sw': // –õ–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π
      resizingElement.style.width = (elementStartWidth - deltaX) + 'px'
      resizingElement.style.height = (elementStartHeight + deltaY) + 'px'
      resizingElement.style.left = (elementStartX + deltaX) + 'px'
      break
    case 'ne': // –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π
      resizingElement.style.width = (elementStartWidth + deltaX) + 'px'
      resizingElement.style.height = (elementStartHeight - deltaY) + 'px'
      resizingElement.style.top = (elementStartY + deltaY) + 'px'
      break
    case 'nw': // –õ–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π
      resizingElement.style.width = (elementStartWidth - deltaX) + 'px'
      resizingElement.style.height = (elementStartHeight - deltaY) + 'px'
      resizingElement.style.left = (elementStartX + deltaX) + 'px'
      resizingElement.style.top = (elementStartY + deltaY) + 'px'
      break
    case 'n': // –í–µ—Ä—Ö
      resizingElement.style.height = (elementStartHeight - deltaY) + 'px'
      resizingElement.style.top = (elementStartY + deltaY) + 'px'
      break
    case 's': // –ù–∏–∑
      resizingElement.style.height = (elementStartHeight + deltaY) + 'px'
      break
    case 'w': // –õ–µ–≤–æ
      resizingElement.style.width = (elementStartWidth - deltaX) + 'px'
      resizingElement.style.left = (elementStartX + deltaX) + 'px'
      break
    case 'e': // –ü—Ä–∞–≤–æ
      resizingElement.style.width = (elementStartWidth + deltaX) + 'px'
      break
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—Ä–∞—Ö
  if (selectedElement.value?.element === resizingElement) {
    selectedElement.value.styles.width = resizingElement.style.width
    selectedElement.value.styles.height = resizingElement.style.height
  }
}

const endResize = () => {
  if (!resizingElement) return
  
  const iframeDoc = previewIframe.value?.contentDocument
  if (iframeDoc) {
    iframeDoc.removeEventListener('mousemove', handleResize)
    iframeDoc.removeEventListener('mouseup', endResize)
  }
  
  addToHistory('resize', resizingElement)
  editorMessage.value = { type: 'success', text: '‚úÖ –†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω—ë–Ω' }
  
  resizingElement = null
  resizeHandle = null
}

const selectElement = (element) => {
  if (!element || element.tagName === 'HTML' || element.tagName === 'BODY') return
  
  const iframeDoc = previewIframe.value?.contentDocument
  if (!iframeDoc) return
  
  // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
  if (selectedElement.value?.element) {
    selectedElement.value.element.classList.remove('visual-editor-selected')
    removeResizeHandles()
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
  element.classList.add('visual-editor-selected')
  
  selectedElement.value = {
    element,
    tagName: element.tagName.toLowerCase(),
    text: element.textContent || '',
    styles: {
      width: element.style.width || '',
      height: element.style.height || '',
      padding: element.style.padding || '',
      margin: element.style.margin || '',
      backgroundColor: element.style.backgroundColor || '',
      color: element.style.color || '',
      fontSize: element.style.fontSize || '',
    },
    attributes: {
      href: element.getAttribute('href') || '',
      src: element.getAttribute('src') || '',
      alt: element.getAttribute('alt') || '',
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º resize handles, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç absolute
  if (element.classList.contains('visual-editor-absolute')) {
    addResizeHandles(element)
  }
}

const addResizeHandles = (element) => {
  const iframeDoc = previewIframe.value?.contentDocument
  if (!iframeDoc) return
  
  const handles = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se']
  
  handles.forEach(position => {
    const handle = iframeDoc.createElement('div')
    handle.className = `visual-editor-resize-handle ${position}`
    handle.dataset.handle = position
    handle.addEventListener('mousedown', handleMouseDown)
    element.appendChild(handle)
  })
}

const removeResizeHandles = () => {
  if (!selectedElement.value?.element) return
  
  const handles = selectedElement.value.element.querySelectorAll('.visual-editor-resize-handle')
  handles.forEach(handle => handle.remove())
}

const addElement = (type) => {
  const iframeDoc = previewIframe.value?.contentDocument
  if (!iframeDoc) return
  
  let newElement
  
  switch(type) {
    case 'button':
      newElement = iframeDoc.createElement('button')
      newElement.textContent = '–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞'
      newElement.className = 'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'
      break
    case 'text':
      newElement = iframeDoc.createElement('p')
      newElement.textContent = '–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫'
      newElement.className = 'text-gray-700'
      break
    case 'heading':
      newElement = iframeDoc.createElement('h2')
      newElement.textContent = '–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫'
      newElement.className = 'text-2xl font-bold'
      break
    case 'image':
      newElement = iframeDoc.createElement('img')
      newElement.src = 'https://via.placeholder.com/300x200'
      newElement.alt = 'Placeholder'
      newElement.className = 'w-64 h-auto'
      break
    case 'div':
      newElement = iframeDoc.createElement('div')
      newElement.textContent = '–ù–æ–≤—ã–π –±–ª–æ–∫'
      newElement.className = 'p-4 border border-gray-300 rounded'
      break
    case 'input':
      newElement = iframeDoc.createElement('input')
      newElement.type = 'text'
      newElement.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'
      newElement.className = 'px-3 py-2 border border-gray-300 rounded'
      break
  }
  
  if (newElement) {
    const iframeDoc = previewIframe.value?.contentDocument
    if (!iframeDoc) return
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü body
    iframeDoc.body.appendChild(newElement)
    
    // –î–µ–ª–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
    newElement.setAttribute('draggable', 'true')
    newElement.classList.add('visual-editor-draggable')
    newElement.addEventListener('mousedown', handleMouseDown)
    
    addToHistory('add', newElement)
    editorMessage.value = { type: 'success', text: `‚úÖ –≠–ª–µ–º–µ–Ω—Ç "${type}" –¥–æ–±–∞–≤–ª–µ–Ω` }
  }
}

const deleteElement = () => {
  if (!selectedElement.value?.element) return
  
  if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
    const element = selectedElement.value.element
    addToHistory('delete', element)
    element.remove()
    selectedElement.value = null
    editorMessage.value = { type: 'success', text: '‚úÖ –≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª—ë–Ω' }
  }
}

const duplicateElement = () => {
  if (!selectedElement.value?.element) return
  
  const element = selectedElement.value.element
  const clone = element.cloneNode(true)
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–ª–æ–Ω —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
  element.parentNode.insertBefore(clone, element.nextSibling)
  
  // –î–µ–ª–∞–µ–º –∫–ª–æ–Ω –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
  clone.setAttribute('draggable', 'true')
  clone.classList.add('visual-editor-draggable')
  clone.addEventListener('mousedown', handleMouseDown)
  
  addToHistory('duplicate', clone)
  editorMessage.value = { type: 'success', text: '‚úÖ –≠–ª–µ–º–µ–Ω—Ç –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω' }
}

const updateElementWidth = () => {
  if (selectedElement.value?.element && elementWidth.value) {
    selectedElement.value.element.style.width = elementWidth.value
    if (!selectedElement.value.styles) selectedElement.value.styles = {}
    selectedElement.value.styles.width = elementWidth.value
  }
}

const updateElementHeight = () => {
  if (selectedElement.value?.element && elementHeight.value) {
    selectedElement.value.element.style.height = elementHeight.value
    if (!selectedElement.value.styles) selectedElement.value.styles = {}
    selectedElement.value.styles.height = elementHeight.value
  }
}

const updateElementPadding = () => {
  if (selectedElement.value?.element && elementPadding.value) {
    selectedElement.value.element.style.padding = elementPadding.value
    if (!selectedElement.value.styles) selectedElement.value.styles = {}
    selectedElement.value.styles.padding = elementPadding.value
  }
}

const updateElementMargin = () => {
  if (selectedElement.value?.element && elementMargin.value) {
    selectedElement.value.element.style.margin = elementMargin.value
    if (!selectedElement.value.styles) selectedElement.value.styles = {}
    selectedElement.value.styles.margin = elementMargin.value
  }
}

const toggleResize = () => {
  if (!selectedElement.value?.element) return
  
  if (enableResize.value) {
    selectedElement.value.element.style.resize = 'both'
    selectedElement.value.element.style.overflow = 'auto'
  } else {
    selectedElement.value.element.style.resize = 'none'
  }
}

const addToHistory = (action, element) => {
  changeHistory.value.push({
    action,
    element: element.cloneNode(true),
    timestamp: Date.now()
  })
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 50 –∑–∞–ø–∏—Å—è–º–∏
  if (changeHistory.value.length > 50) {
    changeHistory.value.shift()
  }
}

const undoChanges = () => {
  if (changeHistory.value.length === 0) {
    alert('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã')
    return
  }
  
  changeHistory.value.pop()
  editorMessage.value = { type: 'success', text: '‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ' }
  refreshPreview()
}

const buildAndDeploy = async () => {
  if (!confirm('üöÄ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å frontend –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã.')) {
    return
  }
  
  isDeploying.value = true
  editorMessage.value = { type: 'success', text: 'üöÄ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ –∏ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.' }
  
  try {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint
    const response = await fetch('/api/v1/super-admin/system/deploy-frontend', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      }
    })
    
    const data = await getJsonData(response)
    
    if (data.success) {
      editorMessage.value = {
        type: 'success',
        text: '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+Shift+R) —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.'
      }
      logger.info('Frontend rebuilt and deployed on server successfully')
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º iframe —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        refreshPreview()
      }, 3000)
    } else {
      throw new Error(data.error || data.output || '–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è')
    }
  } catch (error) {
    logger.error('Build and deploy error:', error)
    editorMessage.value = {
      type: 'error',
      text: '‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: ' + error.message
    }
  } finally {
    isDeploying.value = false
  }
}

// –°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
const loadProcesses = async () => {
  try {
    const response = await fetch('/api/v1/admin/system/processes', {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      processes.value = data.processes
    }
  } catch (error) {
    logger.error('Load processes error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ' + error.message)
  }
}

const loadDockerContainers = async () => {
  try {
    const response = await fetch('/api/v1/admin/system/docker/containers', {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    if (!response.ok) {
      const errorText = await response.text().catch(() => '')
      let errorData
      try {
        errorData = JSON.parse(errorText)
      } catch (e) {
        errorData = { error: errorText || `HTTP ${response.status}` }
      }
      throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`)
    }
    const data = await getJsonData(response)
    if (data.success) {
      dockerContainers.value = data.containers || []
    } else {
      throw new Error(data.error || data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = 'Docker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ. –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π "docker –Ω–µ –Ω–∞–π–¥–µ–Ω"
    if (errorMessage.includes('docker: not found') || errorMessage.includes('docker: command not found')) {
      errorMessage = 'Docker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ. –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.'
    }
    
    logger.error('Load docker containers error:', { error, message: errorMessage })
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: ' + errorMessage)
  }
}

const restartContainer = async (containerId) => {
  if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä?')) return
  try {
    const response = await fetch(`/api/v1/admin/system/docker/container/${containerId}/restart`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      alert('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')
      await loadDockerContainers()
    }
  } catch (error) {
    logger.error('Restart container error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: ' + error.message)
  }
}

const loadRealtimeLogs = async () => {
  try {
    const response = await fetch(`/api/v1/admin/system/logs/realtime?service=${selectedLogService.value}&lines=100`, {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å 200 –¥–∞–∂–µ –µ—Å–ª–∏ success: false)
    const data = await getJsonData(response)
    
    if (data.success) {
      realtimeLogs.value = data.logs || data.data?.logs || ''
      logger.info('Realtime logs loaded', { service: selectedLogService.value })
    } else {
      // Backend –≤–µ—Ä–Ω—É–ª success: false, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
      const errorMsg = data.error || data.message || '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'
      const hint = data.hint || ''
      const logs = data.logs || ''
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –Ω–æ –Ω–µ –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
      realtimeLogs.value = logs || `‚ö†Ô∏è ${errorMsg}${hint ? '\n\nüí° ' + hint : ''}`
      
      logger.warn('Realtime logs not available', { service: selectedLogService.value, error: errorMsg, hint })
      
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (—Ñ–∞–π–ª –ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω)
      if (!errorMsg.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω—ã') && !errorMsg.includes('–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã')) {
        // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert
        console.warn('–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', errorMsg)
      }
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞.'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ –ª–æ–≥–æ–≤ –≤–º–µ—Å—Ç–æ alert
    realtimeLogs.value = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${errorMessage}\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å" –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.`
    
    logger.error('Load realtime logs error:', { error, message: errorMessage })
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –≤ realtimeLogs.value
  }
}

const loadGitStatus = async () => {
  try {
    const response = await fetch('/api/v1/admin/system/git/status', {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    if (!response.ok) {
      const errorText = await response.text().catch(() => '')
      let errorData
      try {
        errorData = JSON.parse(errorText)
      } catch (e) {
        errorData = { error: errorText || `HTTP ${response.status}` }
      }
      throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`)
    }
    const data = await getJsonData(response)
    if (data.success) {
      gitStatus.value = data
    } else {
      throw new Error(data.error || data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å Git')
    }
  } catch (error) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
    if (error?.message) {
      errorMessage = error.message
    } else if (typeof error === 'string') {
      errorMessage = error
    } else if (error?.error) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ error.error –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º
      if (typeof error.error === 'object' && Object.keys(error.error).length === 0) {
        errorMessage = 'Git –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω'
      } else if (typeof error.error === 'string') {
        errorMessage = error.error
      } else {
        errorMessage = JSON.stringify(error.error)
      }
    } else if (error?.toString) {
      errorMessage = error.toString()
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π "git –Ω–µ –Ω–∞–π–¥–µ–Ω"
    if (errorMessage.includes('git: not found') || errorMessage.includes('git: command not found')) {
      errorMessage = 'Git –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ. –°—Ç–∞—Ç—É—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.'
    }
    
    logger.error('Load git status error:', { error, message: errorMessage })
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Git: ' + errorMessage)
  }
}

const loadEnvironmentVariables = async () => {
  try {
    const response = await fetch('/api/v1/admin/system/env', {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      environmentVariables.value = data.environment
    }
  } catch (error) {
    logger.error('Load environment variables error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è: ' + error.message)
  }
}

const loadActiveConnections = async () => {
  try {
    const response = await fetch('/api/v1/admin/system/active-connections', {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      activeConnections.value = data
    }
  } catch (error) {
    logger.error('Load active connections error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: ' + error.message)
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker —Å–µ—Ä–≤–∏—Å–∞–º–∏
const restartBackendService = async () => {
  if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Backend —Å–µ—Ä–≤–∏—Å?')) return
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/docker/restart-service', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ service: 'backend' })
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || data.message || '‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω'
      alert('‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Backend')
    }
  } catch (error) {
    logger.error('Restart backend error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Backend: ' + (error.message || error.toString()))
  }
}

const restartFrontendService = async () => {
  if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Frontend —Å–µ—Ä–≤–∏—Å?')) return
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/docker/restart-service', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ service: 'frontend' })
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || data.message || '‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω'
      alert('‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Frontend')
    }
  } catch (error) {
    logger.error('Restart frontend error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Frontend: ' + (error.message || error.toString()))
  }
}

const getBackendLogs = async () => {
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/docker/logs?service=backend&lines=50', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.logs || '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ Backend')
    }
  } catch (error) {
    logger.error('Get backend logs error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ Backend: ' + (error.message || error.toString()))
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
const getNginxStatus = async () => {
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º super-admin —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Ö–æ—Å—Ç–µ
    const response = await fetch('/api/v1/super-admin/system/execute', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        command: 'docker ps --filter "name=roadhelp-frontend" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || '–°—Ç–∞—Ç—É—Å Nginx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    } else {
      // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
      const hint = data.warning || data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Nginx'
      commandResult.value = hint
      alert('‚ö†Ô∏è ' + hint + '\n\n–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ frontend –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Ö–æ—Å—Ç–µ:\ndocker-compose -f /home/vmroadhelp/docker-compose.production.yml ps frontend')
    }
  } catch (error) {
    logger.error('Get nginx status error:', error)
    const errorMsg = error.message || error.toString()
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Nginx: ' + errorMsg + '\n\n–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ frontend –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Ö–æ—Å—Ç–µ:\ndocker-compose -f /home/vmroadhelp/docker-compose.production.yml ps frontend')
  }
}

const restartNginxService = async () => {
  if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx —Å–µ—Ä–≤–∏—Å?')) return
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/docker/restart-service', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ service: 'frontend' })
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || data.message || '‚úÖ Nginx (frontend) –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω'
      alert('‚úÖ Nginx (frontend) –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Nginx')
    }
  } catch (error) {
    logger.error('Restart nginx error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Nginx: ' + (error.message || error.toString()))
  }
}

const getPostgresStatus = async () => {
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/service/status?service=postgres', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.status || '–°—Ç–∞—Ç—É—Å PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ PostgreSQL')
    }
  } catch (error) {
    logger.error('Get postgres status error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ PostgreSQL: ' + (error.message || error.toString()))
  }
}

const restartPostgresService = async () => {
  if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL —Å–µ—Ä–≤–∏—Å? –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!')) return
  try {
    const token = getToken()
    if (!token) {
      alert('–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }
    const response = await fetch('/api/v1/admin/system/docker/restart-service', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ service: 'postgres' })
    })
    const data = await getJsonData(response)
    if (data.success) {
      commandResult.value = data.output || data.message || '‚úÖ PostgreSQL –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω'
      alert('‚úÖ PostgreSQL –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')
    } else {
      throw new Error(data.error || data.hint || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ PostgreSQL')
    }
  } catch (error) {
    logger.error('Restart postgres error:', error)
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ PostgreSQL: ' + (error.message || error.toString()))
  }
}

// –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const loadAvailableComponents = async () => {
  try {
    // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—É—Ç–µ–π
    const possiblePaths = [
      '/home/vmroadhelp/frontend/src/components',
      '/home/vmroadhelp/roadhelp/frontend/src/components',
      '/app/frontend/src/components',
      '/home/vmroadhelp'
    ]

    let lastError = null
    for (const path of possiblePaths) {
      try {
        const response = await fetch('/api/v1/super-admin/files/list', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${getToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path })
        })
        const data = await getJsonData(response)
        if (data.success && data.items) {
          availableComponents.value = (data.items || []).filter(item => 
            item.type === 'file' && item.name.endsWith('.vue')
          ).map(item => ({
            name: item.name,
            path: item.path
          }))
          logger.info('Available components loaded', { count: availableComponents.value.length, path })
          return // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏, –≤—ã—Ö–æ–¥–∏–º
        }
      } catch (pathError) {
        lastError = pathError
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –ø—É—Ç—å
        continue
      }
    }

    // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –ø—É—Ç—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (lastError) {
      throw lastError
    } else {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.')
    }
  } catch (error) {
    logger.error('Load available components error:', error)
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —Ñ–∞–π–ª–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å" –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.')
  }
}

const selectComponentForEdit = async (component) => {
  selectedComponentForEdit.value = component
  try {
    const response = await fetch('/api/v1/super-admin/files/read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: component.path })
    })
    const data = await getJsonData(response)
    if (data.success) {
      componentEditContent.value = data.content
      if (autoPreview.value) {
        updateLivePreview()
      }
    }
  } catch (error) {
    logger.error('Load component error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: ' + error.message)
  }
}

const updateLivePreview = () => {
  if (!autoPreview.value || !componentEditContent.value) return
  
  try {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º template —á–∞—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const templateMatch = componentEditContent.value.match(/<template>([\s\S]*?)<\/template>/)
    if (templateMatch) {
      livePreviewContent.value = templateMatch[1]
    } else {
      livePreviewContent.value = '<div class="text-gray-500">–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ &lt;template&gt;</div>'
    }
  } catch (error) {
    livePreviewContent.value = '<div class="text-red-500">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message + '</div>'
  }
}

const saveComponentEdit = async () => {
  if (!selectedComponentForEdit.value || !componentEditContent.value) {
    alert('–ù–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    return
  }
  
  savingComponentEdit.value = true
  componentEditMessage.value = null
  
  try {
    const response = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: selectedComponentForEdit.value.path,
        content: componentEditContent.value
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      componentEditMessage.value = { type: 'success', text: '‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω' }
      logger.info('Component saved', { path: selectedComponentForEdit.value.path })
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    }
  } catch (error) {
    logger.error('Save component error:', error)
    componentEditMessage.value = { type: 'error', text: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message }
  } finally {
    savingComponentEdit.value = false
  }
}

const reloadComponentEdit = () => {
  if (selectedComponentForEdit.value) {
    selectComponentForEdit(selectedComponentForEdit.value)
  }
}

const resetComponentEdit = () => {
  if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) {
    reloadComponentEdit()
  }
}

const exportComponent = () => {
  if (!componentEditContent.value) {
    alert('–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞')
    return
  }
  
  const blob = new Blob([componentEditContent.value], { type: 'text/plain' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = selectedComponentForEdit.value?.name || 'component.vue'
  a.click()
  URL.revokeObjectURL(url)
}

const importComponent = () => {
  const input = document.createElement('input')
  input.type = 'file'
  input.accept = '.vue'
  input.onchange = (e) => {
    const file = e.target.files[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (event) => {
        componentEditContent.value = event.target.result
        if (autoPreview.value) {
          updateLivePreview()
        }
      }
      reader.readAsText(file)
    }
  }
  input.click()
}

const validateComponent = () => {
  if (!componentEditContent.value) {
    alert('–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏')
    return
  }
  
  const errors = []
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è template
  if (!componentEditContent.value.includes('<template>')) {
    errors.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫ <template>')
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è script
  if (!componentEditContent.value.includes('<script')) {
    errors.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫ <script>')
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤
  if ((componentEditContent.value.match(/<template>/g) || []).length !== 
      (componentEditContent.value.match(/<\/template>/g) || []).length) {
    errors.push('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤ <template>')
  }
  
  if (errors.length > 0) {
    alert('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n' + errors.join('\n'))
  } else {
    alert('‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–∞–ª–∏–¥–µ–Ω!')
  }
}

const formatComponent = () => {
  if (!componentEditContent.value) {
    alert('–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è')
    return
  }
  
  try {
    // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–æ–≤
    let formatted = componentEditContent.value
    // –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ
    formatted = formatted.replace(/\s{2,}/g, ' ')
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö —Ç–µ–≥–æ–≤
    formatted = formatted.replace(/>/g, '>\n')
    formatted = formatted.replace(/</g, '\n<')
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
    formatted = formatted.replace(/\n{3,}/g, '\n\n')
    
    componentEditContent.value = formatted.trim()
    if (autoPreview.value) {
      updateLivePreview()
    }
    alert('‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω')
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
  }
}

// –§—É–Ω–∫—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ
const loadFileBrowser = async () => {
  try {
    const response = await fetch('/api/v1/super-admin/files/list', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: fileBrowserPath.value || '/home/vmroadhelp' })
    })
    const data = await getJsonData(response)
    if (data.success) {
      fileBrowserItems.value = data.items || []
      selectedFileBrowserItem.value = null
      fileBrowserContent.value = ''
    } else {
      throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤')
    }
  } catch (error) {
    logger.error('Load file browser error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ' + error.message)
  }
}

const refreshFileBrowser = () => {
  loadFileBrowser()
}

const selectFileBrowserItem = (item) => {
  selectedFileBrowserItem.value = item
  if (item.type === 'file') {
    loadFileBrowserFile(item)
  }
}

const openFileBrowserItem = (item) => {
  if (item.type === 'directory') {
    fileBrowserPath.value = item.path
    loadFileBrowser()
  }
}

const goToParentDirectory = () => {
  const pathParts = fileBrowserPath.value.split('/').filter(p => p)
  if (pathParts.length > 0) {
    pathParts.pop()
    fileBrowserPath.value = '/' + pathParts.join('/') || '/'
    loadFileBrowser()
  }
}

const loadFileBrowserFile = async (item) => {
  try {
    const response = await fetch('/api/v1/super-admin/files/read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: item.path })
    })
    const data = await getJsonData(response)
    if (data.success) {
      fileBrowserContent.value = data.content
      fileBrowserSaveMessage.value = null
    } else {
      throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞')
    }
  } catch (error) {
    logger.error('Load file browser file error:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message)
  }
}

const saveFileBrowserFile = async () => {
  if (!selectedFileBrowserItem.value || selectedFileBrowserItem.value.type !== 'file') {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    return
  }
  
  savingFileBrowser.value = true
  fileBrowserSaveMessage.value = null
  
  try {
    const response = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: selectedFileBrowserItem.value.path,
        content: fileBrowserContent.value
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      fileBrowserSaveMessage.value = { type: 'success', text: '‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω' }
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
    }
  } catch (error) {
    logger.error('Save file browser file error:', error)
    fileBrowserSaveMessage.value = { type: 'error', text: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message }
  } finally {
    savingFileBrowser.value = false
  }
}

const reloadFileBrowserFile = () => {
  if (selectedFileBrowserItem.value && selectedFileBrowserItem.value.type === 'file') {
    loadFileBrowserFile(selectedFileBrowserItem.value)
  }
}

const deleteFileBrowserItem = async (item) => {
  const itemType = item.type === 'directory' ? '–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é' : '—Ñ–∞–π–ª'
  if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${itemType} "${item.name}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
    return
  }
  
  try {
    const response = await fetch('/api/v1/super-admin/files/delete', {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: item.path })
    })
    const data = await getJsonData(response)
    if (data.success) {
      alert(`‚úÖ ${itemType === '–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é' ? '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è' : '–§–∞–π–ª'} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`)
      await loadFileBrowser()
      if (selectedFileBrowserItem.value?.path === item.path) {
        selectedFileBrowserItem.value = null
        fileBrowserContent.value = ''
      }
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è')
    }
  } catch (error) {
    logger.error('Delete file browser item error:', error)
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message)
  }
}

const createDirectory = async () => {
  if (!newDirectoryName.value.trim()) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏')
    return
  }
  
  const newPath = fileBrowserPath.value.endsWith('/') 
    ? fileBrowserPath.value + newDirectoryName.value
    : fileBrowserPath.value + '/' + newDirectoryName.value
  
  try {
    const response = await fetch('/api/v1/super-admin/files/create-directory', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: newPath })
    })
    const data = await getJsonData(response)
    if (data.success) {
      alert('‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞')
      showCreateDirectoryModal.value = false
      newDirectoryName.value = ''
      await loadFileBrowser()
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏')
    }
  } catch (error) {
    logger.error('Create directory error:', error)
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: ' + error.message)
  }
}

const createFile = async () => {
  if (!newFileName.value.trim()) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞')
    return
  }
  
  const newPath = fileBrowserPath.value.endsWith('/') 
    ? fileBrowserPath.value + newFileName.value
    : fileBrowserPath.value + '/' + newFileName.value
  
  try {
    const response = await fetch('/api/v1/super-admin/files/write', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        path: newPath,
        content: newFileContent.value || ''
      })
    })
    const data = await getJsonData(response)
    if (data.success) {
      alert('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω')
      showCreateFileModal.value = false
      newFileName.value = ''
      newFileContent.value = ''
      await loadFileBrowser()
    } else {
      throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞')
    }
  } catch (error) {
    logger.error('Create file error:', error)
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message)
  }
}

const handleFileUpload = async (event) => {
  const file = event.target.files[0]
  if (!file) {
    showUploadFileModal.value = false
    return
  }
  
  const reader = new FileReader()
  reader.onload = async (e) => {
    try {
      const content = e.target.result
      const fileName = file.name
      const uploadPath = fileBrowserPath.value.endsWith('/') 
        ? fileBrowserPath.value + fileName
        : fileBrowserPath.value + '/' + fileName
      
      const response = await fetch('/api/v1/super-admin/files/write', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getToken()}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          path: uploadPath,
          content: content
        })
      })
      const data = await getJsonData(response)
      if (data.success) {
        alert('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω')
        showUploadFileModal.value = false
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
        if (fileUploadInput.value) {
          fileUploadInput.value.value = ''
        }
        await loadFileBrowser()
      } else {
        throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞')
      }
    } catch (error) {
      logger.error('Upload file error:', error)
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message)
    }
  }
  reader.onerror = () => {
    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞')
    showUploadFileModal.value = false
  }
  reader.readAsText(file)
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
watch(activeTab, (newTab) => {
  if (newTab === 'visual-interface-editor') {
    loadAvailableComponents()
  }
  if (newTab === 'system-control') {
    loadFileBrowser()
  }
})

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
onMounted(() => {
  if (activeTab.value === 'visual-interface-editor') {
    loadAvailableComponents()
  }
  if (activeTab.value === 'system-control') {
    loadFileBrowser()
  }
})

onMounted(async () => {
  const adminData = localStorage.getItem('admin')
  if (adminData) {
    try {
      admin.value = JSON.parse(adminData)
      if (admin.value.role !== 'super_admin') {
        alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ super_admin')
        router.push('/admin/dashboard')
      } else {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (–Ω–µ –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
        refreshComponents().catch(err => {
          // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ refreshComponents
          console.warn('Failed to refresh components on mount:', err)
        })
      }
    } catch (error) {
      logger.error('Admin panel mount error:', error)
      router.push('/admin/login')
    }
  } else {
    router.push('/admin/login')
  }
})

onUnmounted(() => {
  adminWsService.disconnect()
})
</script>



